<!DOCTYPE html>
<html lang="zh-CN" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content='ä»Šå¤©åœ¨å¤ä¹ ä¹‹å‰çš„é¡¹ç›®æ—¶ï¼Œçœ‹åˆ°è¿™ä¸ªçŸ¥è¯†ç‚¹è§‰å¾—è¿˜æ˜¯æœ‰å¿…è¦è®°å½•ä¸€ä¸‹çš„ï¼Œå› ä¸ºï¼š å¹³æ—¶è‡ªå·±çœ‹å®˜æ–¹æ–‡æ¡£æˆ–è€…å†™ Web æ–¹é¢çš„ Demo é¡¹ç›®ï¼Œå¾ˆå°‘ä¼šå»ä¸“é—¨è€ƒè™‘èº«ä»½éªŒè¯è¿™ä¸ªé—®'>
<meta name="keywords" content="gRPC, å¾®æœåŠ¡, Golang"><title>gRPCæ‹¦æˆªå™¨åœ¨JWTéªŒè¯åœºæ™¯ä¸‹çš„ä½¿ç”¨</title>

<link rel='canonical' href='https://lizonglingo.github.io/p/grpc%E6%8B%A6%E6%88%AA%E5%99%A8%E5%9C%A8jwt%E9%AA%8C%E8%AF%81%E5%9C%BA%E6%99%AF%E4%B8%8B%E7%9A%84%E4%BD%BF%E7%94%A8/'>

<link rel="stylesheet" href="/scss/style.min.811a71d93d8df406268b1c66d015cd3f2252f454f25ac10a683e6f7b5ad9d92d.css"><meta property='og:title' content='gRPCæ‹¦æˆªå™¨åœ¨JWTéªŒè¯åœºæ™¯ä¸‹çš„ä½¿ç”¨'>
<meta property='og:description' content='ä»Šå¤©åœ¨å¤ä¹ ä¹‹å‰çš„é¡¹ç›®æ—¶ï¼Œçœ‹åˆ°è¿™ä¸ªçŸ¥è¯†ç‚¹è§‰å¾—è¿˜æ˜¯æœ‰å¿…è¦è®°å½•ä¸€ä¸‹çš„ï¼Œå› ä¸ºï¼š å¹³æ—¶è‡ªå·±çœ‹å®˜æ–¹æ–‡æ¡£æˆ–è€…å†™ Web æ–¹é¢çš„ Demo é¡¹ç›®ï¼Œå¾ˆå°‘ä¼šå»ä¸“é—¨è€ƒè™‘èº«ä»½éªŒè¯è¿™ä¸ªé—®'>
<meta property='og:url' content='https://lizonglingo.github.io/p/grpc%E6%8B%A6%E6%88%AA%E5%99%A8%E5%9C%A8jwt%E9%AA%8C%E8%AF%81%E5%9C%BA%E6%99%AF%E4%B8%8B%E7%9A%84%E4%BD%BF%E7%94%A8/'>
<meta property='og:site_name' content='fmt.Println(&#34;Li Duo&#34;)'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='gRPC' /><meta property='article:tag' content='å¾®æœåŠ¡' /><meta property='article:tag' content='Golang' /><meta property='article:published_time' content='2023-02-24T00:10:12&#43;08:00'/><meta property='article:modified_time' content='2023-02-24T02:31:12&#43;08:00'/><meta property='og:image' content='https://picgo-lzl.oss-cn-beijing.aliyuncs.com/image-20230224023552733.png' />
<meta name="twitter:title" content="gRPCæ‹¦æˆªå™¨åœ¨JWTéªŒè¯åœºæ™¯ä¸‹çš„ä½¿ç”¨">
<meta name="twitter:description" content="ä»Šå¤©åœ¨å¤ä¹ ä¹‹å‰çš„é¡¹ç›®æ—¶ï¼Œçœ‹åˆ°è¿™ä¸ªçŸ¥è¯†ç‚¹è§‰å¾—è¿˜æ˜¯æœ‰å¿…è¦è®°å½•ä¸€ä¸‹çš„ï¼Œå› ä¸ºï¼š å¹³æ—¶è‡ªå·±çœ‹å®˜æ–¹æ–‡æ¡£æˆ–è€…å†™ Web æ–¹é¢çš„ Demo é¡¹ç›®ï¼Œå¾ˆå°‘ä¼šå»ä¸“é—¨è€ƒè™‘èº«ä»½éªŒè¯è¿™ä¸ªé—®"><meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content='https://picgo-lzl.oss-cn-beijing.aliyuncs.com/image-20230224023552733.png' />
    <link rel="shortcut icon" href="/favicon.ico" />

<script async src="https://www.googletagmanager.com/gtag/js?id=G-SPJXNM3WZ6"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-SPJXNM3WZ6', { 'anonymize_ip': false });
}
</script>
<script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?b30bfbf01ac692ef3da66a21b24e6edb";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>
    
    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="åˆ‡æ¢èœå•">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    <img src="https://picgo-lzl.oss-cn-beijing.aliyuncs.com/1634453613659.jpeg" width="300" height="300" class="site-logo" loading="lazy" alt="Avatar">
                
                </a>
                
                    <span class="emoji">ğŸ‘‹</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">fmt.Println(&#34;Li Duo&#34;)</a></h1>
            <h2 class="site-description"></h2>
        </div>
    </header><ol class="social-menu">
            
                <li>
                    <a 
                        href='https://github.com/lizonglingo'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
            
        
                
                <li >
                    <a href='/' >
                        
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                        
                        <span>ä¸»é¡µ</span>
                    </a>
                </li>
                
            
        
        
            
        
                
                <li >
                    <a href='/%E5%85%B3%E4%BA%8E/' >
                        
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                        
                        <span>å…³äº</span>
                    </a>
                </li>
                
            
        
        
            
        
                
                <li >
                    <a href='/archives/' >
                        
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                        
                        <span>å½’æ¡£</span>
                    </a>
                </li>
                
            
        
        
            
        
                
                <li >
                    <a href='/%E9%93%BE%E6%8E%A5/' >
                        
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                        
                        <span>é“¾æ¥</span>
                    </a>
                </li>
                
            
        
        
            
        
        

        <div class="menu-bottom-section">
            
            
                <li id="dark-mode-toggle">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <span>æš—è‰²æ¨¡å¼</span>
                </li>
            
        </div>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                <form action="/search/" class="search-form widget" >
        <p>
            <label>æœç´¢</label>
            <input name="keyword" required placeholder="è¾“å…¥å…³é”®è¯..." />
        
            <button title="æœç´¢">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



            </button>
        </p>
    </form>
            
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">ç›®å½•</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ul>
    <li><a href="#jwt-tokenåŸç†">JWT TokenåŸç†</a>
      <ul>
        <li><a href="#jwt-çš„ä¸€äº›æ¦‚å¿µ">JWT çš„ä¸€äº›æ¦‚å¿µ</a></li>
        <li><a href="#rsa-éå¯¹ç§°åŠ å¯†">RSA éå¯¹ç§°åŠ å¯†</a></li>
      </ul>
    </li>
    <li><a href="#golang-å®ç°-jwt-çš„-token-é¢å‘å’ŒéªŒè¯">Golang å®ç° JWT çš„ token é¢å‘å’ŒéªŒè¯</a>
      <ul>
        <li><a href="#ç”Ÿæˆ-jwt">ç”Ÿæˆ JWT</a></li>
        <li><a href="#éªŒè¯-jwt">éªŒè¯ JWT</a></li>
      </ul>
    </li>
    <li><a href="#ä½¿ç”¨-grpc-æ‹¦æˆªå™¨--context-æœºåˆ¶å°†éªŒè¯æ¥å…¥å…¬å…±é€»è¾‘">ä½¿ç”¨ gRPC æ‹¦æˆªå™¨ + Context æœºåˆ¶å°†éªŒè¯æ¥å…¥å…¬å…±é€»è¾‘</a>
      <ul>
        <li><a href="#å¼•å…¥-grpc-interceptor">å¼•å…¥ gRPC Interceptor</a></li>
        <li><a href="#ä¸€ä¸ªéªŒè¯-token-å¹¶è½¬åŒ–ä¸º-userid-çš„æ‹¦æˆªå™¨">ä¸€ä¸ªéªŒè¯ token å¹¶è½¬åŒ–ä¸º userID çš„æ‹¦æˆªå™¨</a></li>
      </ul>
    </li>
  </ul>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="has-image main-article">
    <header class="article-header">
        <div class="article-image">
            <a href="/p/grpc%E6%8B%A6%E6%88%AA%E5%99%A8%E5%9C%A8jwt%E9%AA%8C%E8%AF%81%E5%9C%BA%E6%99%AF%E4%B8%8B%E7%9A%84%E4%BD%BF%E7%94%A8/">
                
                    <img src="https://picgo-lzl.oss-cn-beijing.aliyuncs.com/image-20230224023552733.png" loading="lazy" alt="Featured image of post gRPCæ‹¦æˆªå™¨åœ¨JWTéªŒè¯åœºæ™¯ä¸‹çš„ä½¿ç”¨" />
                
            </a>
        </div>
    

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/grpc/" >
                gRPC
            </a>
        
            <a href="/categories/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" >
                å¾®æœåŠ¡
            </a>
        
            <a href="/categories/golang/" >
                Golang
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/grpc%E6%8B%A6%E6%88%AA%E5%99%A8%E5%9C%A8jwt%E9%AA%8C%E8%AF%81%E5%9C%BA%E6%99%AF%E4%B8%8B%E7%9A%84%E4%BD%BF%E7%94%A8/">gRPCæ‹¦æˆªå™¨åœ¨JWTéªŒè¯åœºæ™¯ä¸‹çš„ä½¿ç”¨</a>
        </h2>
    
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Feb 24, 2023</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    é˜…è¯»æ—¶é•¿: 5 åˆ†é’Ÿ
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <blockquote>
<p>ä»Šå¤©åœ¨å¤ä¹ ä¹‹å‰çš„é¡¹ç›®æ—¶ï¼Œçœ‹åˆ°è¿™ä¸ªçŸ¥è¯†ç‚¹è§‰å¾—è¿˜æ˜¯æœ‰å¿…è¦è®°å½•ä¸€ä¸‹çš„ï¼Œå› ä¸ºï¼š</p>
<ol>
<li>å¹³æ—¶è‡ªå·±çœ‹å®˜æ–¹æ–‡æ¡£æˆ–è€…å†™ Web æ–¹é¢çš„ Demo é¡¹ç›®ï¼Œå¾ˆå°‘ä¼šå»ä¸“é—¨è€ƒè™‘èº«ä»½éªŒè¯è¿™ä¸ªé—®é¢˜ã€‚ä¸€èˆ¬å†™ç€ç©çš„ API éƒ½ä¸ä¼šå¤ªé‡è§†å®‰å…¨é—®é¢˜ï¼Œéš¾å¾—å¤ä¹ åˆ°è¿™ä¸€ç‚¹ã€‚</li>
<li>JWT Token åœ¨ Web ä¸­æ˜¯ä¸€ç§å¸¸è§çš„èº«ä»½éªŒè¯æ–¹å¼ï¼Œä¹Ÿæ˜¯ Web å¼€å‘ä¸­å®‰å…¨ç›¸å…³çš„é‡è¦çŸ¥è¯†ã€‚</li>
</ol>
<p>æœ¬æ–‡æ‰€åˆ†äº«çš„ä½¿ç”¨ gRPC æ‹¦æˆªå™¨å’Œ Context çš„ä½¿ç”¨åœºæ™¯æ˜¯ï¼šè§£æ Token å¹¶å¸¦ç€ç”¨æˆ·ä¿¡æ¯å–æ‰§è¡Œå„ä¸ªè¯·æ±‚ã€‚</p>
</blockquote>
<p>æœ¬æ–‡ä»ä»¥ä¸‹ä¸‰ä¸ªæ­¥éª¤å±•å¼€åˆ†äº«ï¼š</p>
<ol>
<li>é€šè¿‡ç”¨æˆ· ID ç”Ÿæˆ Token</li>
<li>éªŒè¯ Token å¾—åˆ°ç”¨æˆ· ID</li>
<li>é€šè¿‡ gRPC æ‹¦æˆªå™¨å’Œ Context æŠŠ Token éªŒè¯è½¬ä¸ºå…¬å…±çš„é€»è¾‘</li>
</ol>
<h2 id="jwt-tokenåŸç†">JWT TokenåŸç†</h2>
<h3 id="jwt-çš„ä¸€äº›æ¦‚å¿µ">JWT çš„ä¸€äº›æ¦‚å¿µ</h3>
<blockquote>
<p><a class="link" href="https://jwt.io/"  target="_blank" rel="noopener"
    >https://jwt.io/</a></p>
</blockquote>
<p><img src="https://picgo-lzl.oss-cn-beijing.aliyuncs.com/image-20230222234847804.png"
	
	
	
	loading="lazy"
	
		alt="image-20230222234847804"
	
	
></p>
<p>è¿™å¼ å›¾ç‰‡åŒ…å«äº† JWT æœ€é‡è¦çš„ä¸€äº›æ¦‚å¿µã€‚åœ¨ <strong>Encoded</strong> ä¸­ï¼Œçº¢è‰²å’Œç´«è‰²å­—æ®µæ˜¯é€šè¿‡ <strong>Base64</strong> ç¼–ç è€Œæ¥ï¼Œå¯¹åº” <strong>HEADER</strong> å’Œ <strong>PAYLOAD</strong> å­—æ®µï¼Œå®é™…ä¸Šå°±æ˜¯æ˜æ–‡ï¼Œä»»ä½•äººéƒ½èƒ½é€šè¿‡ Base64 è§£ç å¾—åˆ°ã€‚</p>
<p>è€Œè“è‰²å­—æ®µåˆ™æ˜¯é€šè¿‡åŠ å¯†ç”Ÿæˆçš„ã€‚</p>
<p>Decodedä¸­çš„å­—æ®µå’Œå«ä¹‰å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#75715e">// HEADER
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;alg&#34;</span>: <span style="color:#e6db74">&#34;HS256&#34;</span>,	<span style="color:#75715e">// ä½¿ç”¨çš„ç®—æ³•ç±»å‹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#f92672">&#34;typ&#34;</span>: <span style="color:#e6db74">&#34;JWT&#34;</span>		<span style="color:#75715e">// ç±»å‹æ˜¯ JWT
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e">// PAYLOAD åŒ…å«å¾ˆå¤šé»˜è®¤å­—æ®µ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;sub&#34;</span>: <span style="color:#e6db74">&#34;1234567890&#34;</span>,	<span style="color:#75715e">// è¿™ä¸ª JWT é¢å‘ç»™ 1234567890 å¯ä»¥ç†è§£ä¸ºç”¨æˆ· ID
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;John Doe&#34;</span>,	<span style="color:#75715e">// ç”¨æˆ·çš„åå­—
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#f92672">&#34;iat&#34;</span>: <span style="color:#ae81ff">1516239022</span>,	<span style="color:#75715e">// é¢å‘çš„æ—¶é—´
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#f92672">&#34;exp&#34;</span>: <span style="color:#ae81ff">1516239922</span>,	<span style="color:#75715e">// è¿‡æœŸæ—¶é—´
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#f92672">&#34;iss&#34;</span>: <span style="color:#e6db74">&#34;auth&#34;</span>			<span style="color:#75715e">// é¢å‘æœºæ„
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><h3 id="rsa-éå¯¹ç§°åŠ å¯†">RSA éå¯¹ç§°åŠ å¯†</h3>
<p>ä¸Šæ–‡ä¸­ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;alg&#34;</span>: <span style="color:#e6db74">&#34;HS256&#34;</span>,	<span style="color:#75715e">// ä½¿ç”¨çš„ç®—æ³•ç±»å‹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#f92672">&#34;typ&#34;</span>: <span style="color:#e6db74">&#34;JWT&#34;</span>		<span style="color:#75715e">// ç±»å‹æ˜¯ JWT
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><p>æœ‰ä¸ªå­—æ®µè¡¨ç¤ºåŠ å¯†ä½¿ç”¨çš„ç®—æ³•ï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ RSA éå¯¹ç§°åŠ å¯†ã€‚åŠ è§£å¯†è¿‡ç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li>B å°†æ˜æ–‡ä½¿ç”¨ Hash ç®—æ³•è¿ç®—å¾—åˆ°æ‘˜è¦</li>
<li>æ‘˜è¦ä½¿ç”¨ B çš„ç§é’¥è¿›è¡Œç­¾åï¼Œä¹Ÿå°±æ˜¯åŠ å¯†</li>
<li>ç­¾åè¿åŒæ˜æ–‡å‘ç»™ A</li>
<li>A å…ˆå°†æ˜æ–‡ç”¨åŒæ ·çš„ Hash ç®—æ³•è®¡ç®—æ‘˜è¦</li>
<li>å†ä½¿ç”¨ B çš„å…¬é’¥ï¼Œä»ç­¾åä¸­è§£å‡ºæ‘˜è¦ï¼Œä¹Ÿå°±æ˜¯è§£å¯†</li>
<li>å¯¹æ¯” Hash(æ˜æ–‡) å’Œ è§£å¯†(ç­¾å) çš„æ‘˜è¦æ˜¯å¦ç›¸åŒ</li>
</ol>
<p><strong>B çš„ç§é’¥åªæœ‰ B è‡ªå·±çŸ¥é“</strong>ï¼Œ<strong>B çš„å…¬é’¥æ‰€æœ‰äººéƒ½èƒ½çŸ¥é“</strong>ã€‚<strong>é€šè¿‡ç­¾åå’ŒéªŒè¯ç­¾åï¼Œä¿è¯æ¶ˆæ¯ç¡®å®æ˜¯ B æ‰€å‘çš„ï¼Œè€Œ Hash ç®—æ³•åˆ™ä¿è¯æ˜æ–‡æ²¡æœ‰è¢«ç¯¡æ”¹è¿‡</strong>ã€‚</p>
<p>è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯å¦‚ä½•è¯æ˜å…¬é’¥ç¡®å®æ˜¯ B çš„å…¬é’¥ï¼Œè€Œä¸æ˜¯å…¶ä»–äººçš„å‘¢ï¼Ÿè¿™å°±æ˜¯ CA çš„ä½œç”¨äº†ã€‚</p>
<p>é€šè¿‡ä¸Šè¿°æ–¹æ³•ï¼ŒæœåŠ¡å™¨å°† JWT å¸¦çš„ä¿¡æ¯ï¼Œå¦‚ç”¨æˆ·IDã€ç”¨æˆ·åã€è¿‡æœŸæ—¶é—´ç­‰ä¿¡æ¯ï¼Œä» token è§£å‡ºæ¥ï¼Œè¯æ˜è¿™ä¸ª token ç¡®å®æ˜¯è‡ªå·±çš„æœåŠ¡å™¨æ‰€é¢å‘çš„ï¼Œå¹¶ä¸”å®ƒçš„ä¿¡æ¯ä¹Ÿæ˜¯æ²¡æœ‰è¢«ä¿®æ”¹è¿‡çš„ã€‚å› æ­¤ï¼Œç”¨æˆ·èº«ä»½çš„å®‰å…¨æ€§å°±åœ¨äºæœ‰æ²¡æœ‰ä¿æŠ¤å¥½è‡ªå·±çš„ token ä¸è¢«åˆ«äººçªƒå–ã€‚å½“ç„¶ï¼Œè¿™ç§è¡Œä¸ºå­˜åœ¨éš¾åº¦ã€‚</p>
<p><img src="https://picgo-lzl.oss-cn-beijing.aliyuncs.com/image-20230223001741312.png"
	
	
	
	loading="lazy"
	
		alt="image-20230223001741312"
	
	
></p>
<h2 id="golang-å®ç°-jwt-çš„-token-é¢å‘å’ŒéªŒè¯">Golang å®ç° JWT çš„ token é¢å‘å’ŒéªŒè¯</h2>
<p>è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ <code>&quot;github.com/dgrijalva/jwt-go&quot;</code> è¿™ä¸ªåº“æ¥å®ç°ï¼ŒåŠ å¯†æ–¹å¼ä½¿ç”¨ 2048ä½çš„ RSAï¼Œé€šè¿‡åœ¨çº¿çš„ RSA å…¬ç§é’¥ç”Ÿæˆç½‘ç«™å¯ä»¥è·å–å…¬é’¥æ–‡ä»¶å’Œç§é’¥æ–‡ä»¶çš„ demoã€‚</p>
<h3 id="ç”Ÿæˆ-jwt">ç”Ÿæˆ JWT</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">token</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;crypto/rsa&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;github.com/dgrijalva/jwt-go&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">JWTTokenGen</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">privateKey</span>  <span style="color:#f92672">*</span><span style="color:#a6e22e">rsa</span>.<span style="color:#a6e22e">PrivateKey</span>		<span style="color:#75715e">// ç§é’¥
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">issue</span>       <span style="color:#66d9ef">string</span>				<span style="color:#75715e">// é¢å‘æœºæ„
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">nowTimeFunc</span> <span style="color:#66d9ef">func</span>() <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Time</span>	<span style="color:#75715e">// ç”Ÿæˆæ—¶é—´
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewJWTTokenGen</span>(<span style="color:#a6e22e">issue</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">privateKey</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">rsa</span>.<span style="color:#a6e22e">PrivateKey</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">JWTTokenGen</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">JWTTokenGen</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">privateKey</span>:  <span style="color:#a6e22e">privateKey</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">issue</span>:       <span style="color:#a6e22e">issue</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">nowTimeFunc</span>: <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>,		<span style="color:#75715e">// é¢å‘æ—¶ä½¿ç”¨å½“å‰æ—¶é—´
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">j</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">JWTTokenGen</span>) <span style="color:#a6e22e">GenerateToken</span>(<span style="color:#a6e22e">accountID</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">expire</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Duration</span>) (<span style="color:#66d9ef">string</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">nowSec</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">j</span>.<span style="color:#a6e22e">nowTimeFunc</span>().<span style="color:#a6e22e">Unix</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ä½¿ç”¨ NewWithClaims ç”Ÿæˆ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// ä½¿ç”¨ SHA512 åš hash
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">token</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">jwt</span>.<span style="color:#a6e22e">NewWithClaims</span>(<span style="color:#a6e22e">jwt</span>.<span style="color:#a6e22e">SigningMethodRS512</span>, <span style="color:#a6e22e">jwt</span>.<span style="color:#a6e22e">StandardClaims</span>{
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// StandardClaims å°±å¯¹åº” jwt.io ä¸­ body çš„å†…å®¹å­—æ®µ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">Issuer</span>:    <span style="color:#a6e22e">j</span>.<span style="color:#a6e22e">issue</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">IssuedAt</span>:  <span style="color:#a6e22e">nowSec</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">ExpiresAt</span>: <span style="color:#a6e22e">nowSec</span> <span style="color:#f92672">+</span> int64(<span style="color:#a6e22e">expire</span>.<span style="color:#a6e22e">Seconds</span>()),
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Subject</span>:   <span style="color:#a6e22e">accountID</span>,
</span></span><span style="display:flex;"><span>	})
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// æŠŠ token ä½¿ç”¨ç§é’¥ç­¾åå ä»¥å­—ç¬¦ä¸²å½¢å¼è¿”å›
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">token</span>.<span style="color:#a6e22e">SignedString</span>(<span style="color:#a6e22e">j</span>.<span style="color:#a6e22e">privateKey</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ä¸Šæ–‡ä¸­ <code>*rsa.PrivateKey	</code> è¯»å–æ–¹å¼å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// å…¶ä¸­ *rsa.PrivateKey ä» ç§é’¥æ–‡ä»¶ä¸­è¯»å–
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// ä½¿ç”¨ jwt.ParseRSAPrivateKeyFromPEM åŠ è½½
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">pkFile</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Open</span>(<span style="color:#f92672">*</span><span style="color:#a6e22e">privateKeyFile</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">pkBytes</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ioutil</span>.<span style="color:#a6e22e">ReadAll</span>(<span style="color:#a6e22e">pkFile</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">privateKey</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">jwt</span>.<span style="color:#a6e22e">ParseRSAPrivateKeyFromPEM</span>(<span style="color:#a6e22e">pkBytes</span>)
</span></span></code></pre></div><h3 id="éªŒè¯-jwt">éªŒè¯ JWT</h3>
<p>éªŒè¯ JWT æ˜¯é¢å‘ JWT çš„åè¿‡ç¨‹ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// Package token éªŒè¯token è§£æ accountID.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">package</span> <span style="color:#a6e22e">token</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;crypto/rsa&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;github.com/dgrijalva/jwt-go&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// JWTTokenVerifier å®ç° token verifyæ¥å£.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">JWTTokenVerifier</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">PublicKey</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">rsa</span>.<span style="color:#a6e22e">PublicKey</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Verify ç”¨è‡ªå·±çš„å…¬é’¥å»éªŒè¯ token æ˜¯å¦æœ‰æ•ˆ.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">jwtv</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">JWTTokenVerifier</span>) <span style="color:#a6e22e">Verify</span>(<span style="color:#a6e22e">token</span> <span style="color:#66d9ef">string</span>) (<span style="color:#66d9ef">string</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ä½¿ç”¨ ParseWithClaims è§£å‡º token ä¿¡æ¯ è¿™é‡Œå°±æ˜¯æ‰€è°“çš„ claim
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// å‡½æ•°ç­¾åä¸º func ParseWithClaims(tokenString string, claims Claims, keyFunc Keyfunc) (*Token, error)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// ç¬¬ä¸‰ä¸ªå‚æ•°ä½œç”¨æ˜¯è·å¾—éªŒç­¾çš„å…¬é’¥ è¿™é‡Œç›´æ¥è¿”å›å…¬é’¥
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">t</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">jwt</span>.<span style="color:#a6e22e">ParseWithClaims</span>(<span style="color:#a6e22e">token</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">jwt</span>.<span style="color:#a6e22e">StandardClaims</span>{}, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">token</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">jwt</span>.<span style="color:#a6e22e">Token</span>) (<span style="color:#66d9ef">interface</span>{}, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">jwtv</span>.<span style="color:#a6e22e">PublicKey</span>, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>	})
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;cannot parse token: %v\n&#34;</span>, <span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// å¦‚æœæ²¡æœ‰é€šè¿‡éªŒè¯
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Valid</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;token not valid\n&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// è§£å‡ºå…¶ä¸­çš„ claim å­—æ®µå¹¶éªŒè¯
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">claim</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Claims</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">jwt</span>.<span style="color:#a6e22e">StandardClaims</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">ok</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;token claim is not standard claim\n&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span><span style="color:#a6e22e">claim</span>.<span style="color:#a6e22e">Valid</span>(); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;claim not valid: %v\n&#34;</span>, <span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// è¿™é‡Œçš„ claim.Subject å°±æ˜¯æ„é€  token æ˜¯å¡«å…¥çš„ accountID
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// token := jwt.NewWithClaims(jwt.SigningMethodRS512, jwt.StandardClaims{
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//	Issuer:    j.issue,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//	IssuedAt:  nowSec,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//	ExpiresAt: nowSec + int64(expire.Seconds()),
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//	Subject:   accountID,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// })
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">claim</span>.<span style="color:#a6e22e">Subject</span>, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ä¸Šæ–‡ä¸­çš„å…¬é’¥é€šè¿‡ä¸‹é¢æ–¹æ³•è¯»å–ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// å…¶ä¸­ *rsa.PublicKey ä¹Ÿæ˜¯é€šè¿‡æ–‡ä»¶è¯»å– å†ç”± jwt.ParseRSAPublicKeyFromPEM åŠ è½½
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">f</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Open</span>(<span style="color:#a6e22e">publicKeyFile</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">b</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ioutil</span>.<span style="color:#a6e22e">ReadAll</span>(<span style="color:#a6e22e">f</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">pubKey</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">jwt</span>.<span style="color:#a6e22e">ParseRSAPublicKeyFromPEM</span>(<span style="color:#a6e22e">b</span>)
</span></span></code></pre></div><h2 id="ä½¿ç”¨-grpc-æ‹¦æˆªå™¨--context-æœºåˆ¶å°†éªŒè¯æ¥å…¥å…¬å…±é€»è¾‘">ä½¿ç”¨ gRPC æ‹¦æˆªå™¨ + Context æœºåˆ¶å°†éªŒè¯æ¥å…¥å…¬å…±é€»è¾‘</h2>
<p>å¯¹äºåç«¯æ‰€æœ‰çš„æœåŠ¡ï¼Œæˆ‘ä»¬éƒ½éœ€è¦éªŒè¯è¿™æ¡è¯·æ±‚æ˜¯å¦åˆæ³•ï¼Œä¾‹å¦‚ï¼šæ˜¯ä¸æ˜¯å·²ç»ç™»å½•çš„ç”¨æˆ·å‘èµ·çš„è¯·æ±‚ã€tokenæœ‰æ²¡æœ‰è¿‡æœŸæˆ–è€…æ˜¯å¦æ­£ç¡®ã€‚è¿™é¡¹å·¥ä½œå¯ä»¥ç»Ÿä¸€åœ¨ API çš„å¤–éƒ¨å…¥å£å¤„è¿›è¡Œï¼Œåœ¨è¿›å…¥å†…éƒ¨å¾®æœåŠ¡åï¼Œä½¿ç”¨åŒ…å«ç”¨æˆ· id çš„ context åœ¨ä¸åŒå¾®æœåŠ¡ä¹‹å‰å®ç°è¯·æ±‚èº«ä»½çš„æ ‡è¯†ã€‚</p>
<blockquote>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œä»å†…éƒ¨å…¥å£ï¼ˆå¦‚å¾®æœåŠ¡ç½‘å…³ï¼‰è¿›å…¥çš„è¯·æ±‚æ²¡æœ‰é—®é¢˜ï¼Œé‚£ä¹ˆåœ¨å†…éƒ¨çš„å¾®æœåŠ¡ä¸­å°±æ˜¯å®‰å…¨çš„ï¼Œå› ä¸ºå†…éƒ¨å¾®æœåŠ¡ä¸ä¼šå‘å¤–æš´éœ²æ¥å£ã€‚</p>
</blockquote>
<h3 id="å¼•å…¥-grpc-interceptor">å¼•å…¥ gRPC Interceptor</h3>
<p>gRPC Interceptor å°±ç†è§£ä¸º gin ä¸­çš„ middlewareï¼Œæ‹¦æˆªè¯·æ±‚åšä¸€äº›å¤„ç†ä¹‹åå†æ”¾è¡Œã€‚</p>
<p>åœ¨ NewServer æ—¶ä¼šæœ‰ä¸€äº›é€‰é¡¹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// func NewServer(opt ...ServerOption) *Server
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// æ¥æ”¶ä¸€ä¸ª ServerOption åˆ—è¡¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// type ServerOption interface {
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//	apply(*serverOptions)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// }
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// serverOption æ˜¯ä¸€ç§å®ç°
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// type serverOption struct {
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//	grpc.EmptyServerOption
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//	apply func(*serverOptions)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">NewServer</span>([]<span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">ServerOption</span><span style="color:#f92672">...</span>)
</span></span></code></pre></div><p>è€Œ <code>UnaryInterceptor</code> è¿”å›çš„ <code>ServerOption</code> æ˜¯å…¶ä¸­çš„ä¸€ç§å®ç°ï¼Œè¿™é‡Œæˆ‘ä»¬å°±ç”¨æœ€ç®€å•çš„ <code>UnaryInterceptor</code> æ¼”ç¤ºï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// func UnaryInterceptor(i UnaryServerInterceptor) ServerOption
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// å‚æ•°æ˜¯ä¸€ä¸ªå‡½æ•° ç­¾åå¦‚ä¸‹ï¼š
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// type UnaryServerInterceptor func(ctx context.Context, req interface{}, info *UnaryServerInfo, handler UnaryHandler) (resp interface{}, err error)
</span></span></span></code></pre></div><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬åªéœ€è¦å®šä¹‰å¥½ <code>UnaryServerInterceptor</code> è¿™ä¸ªå‡½æ•°ï¼ŒæŠŠå®ƒäº¤ç»™ <code>UnaryInterceptor</code>ï¼Œå†æŠŠ <code>UnaryInterceptor</code> äº¤ç»™ <code>ServerOption</code> åˆ—è¡¨ï¼Œæœ€ååœ¨ <code>NewServer</code> æ—¶æŠŠ <code>ServerOption</code> åˆ—è¡¨ä¼ å…¥ï¼Œæˆ‘ä»¬çš„ gRPC Server å°±åŒ…å«æˆ‘ä»¬è‡ªå®šä¹‰çš„è¿™ä¸ªæ‹¦æˆªå™¨äº†ã€‚</p>
<h3 id="ä¸€ä¸ªéªŒè¯-token-å¹¶è½¬åŒ–ä¸º-userid-çš„æ‹¦æˆªå™¨">ä¸€ä¸ªéªŒè¯ token å¹¶è½¬åŒ–ä¸º userID çš„æ‹¦æˆªå™¨</h3>
<h4 id="1-æ„é€ -unaryserverinterceptor">1. æ„é€  UnaryServerInterceptor</h4>
<p>ä¹Ÿå°±æ˜¯å®ç°è¿™æ ·ä¸€ä¸ªå‡½æ•°ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">auth</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;context&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">jwt</span> <span style="color:#e6db74">&#34;github.com/dgrijalva/jwt-go&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;google.golang.org/grpc&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;google.golang.org/grpc/codes&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;google.golang.org/grpc/metadata&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;google.golang.org/grpc/status&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;io/ioutil&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;strings&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">ImpersonateAccountHeader</span> = <span style="color:#e6db74">&#34;impersonate-account-id&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">authorizationHeader</span> = <span style="color:#e6db74">&#34;authorization&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">bearerPrefix</span> = <span style="color:#e6db74">&#34;Bearer &#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">tokenVerify</span> <span style="color:#66d9ef">interface</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Verify</span>(<span style="color:#a6e22e">token</span> <span style="color:#66d9ef">string</span>) (<span style="color:#66d9ef">string</span>, <span style="color:#66d9ef">error</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">interceptor</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// éœ€è¦ä¸€ä¸ª tokenVerify æ¥å£çš„å®ç°
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// æˆ‘ä»¬ä¹‹å‰å®ç°äº†ä¸€ä¸ª JWT çš„éªŒè¯å™¨ ç›´æ¥ç”¨å°±è¡Œ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// type JWTTokenVerifier struct {
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//	PublicKey *rsa.PublicKey
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// }
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">verifier</span> <span style="color:#a6e22e">tokenVerify</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// HandleRequest ä½œä¸ºè¯·æ±‚æ‹¦æˆªå¤„ç†å™¨ï¼Œè¿”å›çš„handleræ˜¯æ¥ä¸‹æ¥éœ€è¦åšçš„å¤„ç†å‡½æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// å®ç° grpc.UnaryServerInterceptor å‡½æ•°ï¼š
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// type UnaryServerInterceptor func(ctx context.Context, req interface{}, info *UnaryServerInfo, handler UnaryHandler) (resp interface{}, err error)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">i</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">interceptor</span>) <span style="color:#a6e22e">HandleRequest</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>,
</span></span><span style="display:flex;"><span>									<span style="color:#a6e22e">req</span> <span style="color:#66d9ef">interface</span>{},
</span></span><span style="display:flex;"><span>									<span style="color:#a6e22e">info</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">UnaryServerInfo</span>,
</span></span><span style="display:flex;"><span>									<span style="color:#a6e22e">handler</span> <span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">UnaryHandler</span>) (<span style="color:#a6e22e">resp</span> <span style="color:#66d9ef">interface</span>{}, <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>)  {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 0. å…ˆæ£€æŸ¥æ˜¯å¦åŠ å…¥ç‰¹æ®Šèº«ä»½æ ‡è¯†
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//    å¦‚æœæœ‰å°±è¯æ˜ context ä¸­çš„ token å·²ç»è§£å‡º ä»¥ userID å½¢å¼åœ¨ context ä¸­ä¼ é€’
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//    å¦åˆ™ä» token ä¸­è§£å‡º
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">accountID</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">impersonationFromContext</span>(<span style="color:#a6e22e">ctx</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">accountID</span> <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">handler</span>(<span style="color:#a6e22e">ContextWithAccountID</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">id</span>.<span style="color:#a6e22e">AccountID</span>(<span style="color:#a6e22e">accountID</span>)), <span style="color:#a6e22e">req</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 1. åœ¨è¿™ä¹‹å‰å·²å°†tokenåŠ å…¥context
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//    ä»æœ€åˆçš„contextä¸­æ‹¿åˆ°token
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">tkn</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">tokenFromContext</span>(<span style="color:#a6e22e">ctx</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">status</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#a6e22e">codes</span>.<span style="color:#a6e22e">Unauthenticated</span>, <span style="color:#e6db74">&#34;&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 2. éªŒè¯token æ‹¿åˆ° accountID
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">accountID</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">i</span>.<span style="color:#a6e22e">verifier</span>.<span style="color:#a6e22e">Verify</span>(<span style="color:#a6e22e">tkn</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">status</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#a6e22e">codes</span>.<span style="color:#a6e22e">Unauthenticated</span>, <span style="color:#e6db74">&#34;token not valid: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 3. å°† accountID æ”¾å…¥ context ä¸­ï¼Œäº¤ç»™åç»­çš„è¯·æ±‚æ‰§è¡Œ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// 	  æ‹¦æˆªå™¨æ•è· context å–å‡ºtoken
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//    éªŒè¯ token è·å– accountID
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//	  å°† accountID æ”¾è¿› context
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//	  æŠŠæ–°çš„ context ä¼ ä¸‹å»æ‰çœŸæ­£äº¤ç»™åé¢çš„å¾®æœåŠ¡æ‰§è¡Œ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">handler</span>(<span style="color:#a6e22e">ContextWithAccountID</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">id</span>.<span style="color:#a6e22e">AccountID</span>(<span style="color:#a6e22e">accountID</span>)), <span style="color:#a6e22e">req</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// impersonationFromContext åˆ¤æ–­æ˜¯å¦éœ€è¦éªŒè¯ token æˆ–æ˜¯ context ä¸­å·²ç»éªŒè¯å®Œ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">impersonationFromContext</span>(<span style="color:#a6e22e">c</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>) <span style="color:#66d9ef">string</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">m</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">metadata</span>.<span style="color:#a6e22e">FromIncomingContext</span>(<span style="color:#a6e22e">c</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">ok</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">imp</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">m</span>[<span style="color:#a6e22e">ImpersonateAccountHeader</span>]
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">imp</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">imp</span>[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// tokenFromContext ä» context ä¸­æ‹¿åˆ° token
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">tokenFromContext</span>(<span style="color:#a6e22e">c</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>) (<span style="color:#66d9ef">string</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">m</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">metadata</span>.<span style="color:#a6e22e">FromIncomingContext</span>(<span style="color:#a6e22e">c</span>)	<span style="color:#75715e">// æŸ¥çœ‹è¯·æ±‚æœ‰æ²¡æœ‰æ•°æ®
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">ok</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#a6e22e">status</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#a6e22e">codes</span>.<span style="color:#a6e22e">Unauthenticated</span>, <span style="color:#e6db74">&#34;&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">tkn</span> <span style="color:#f92672">:=</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">v</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">m</span>[<span style="color:#a6e22e">authorizationHeader</span>] {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">HasPrefix</span>(<span style="color:#a6e22e">v</span>, <span style="color:#a6e22e">bearerPrefix</span>) {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">tkn</span> = <span style="color:#a6e22e">v</span>[len(<span style="color:#a6e22e">bearerPrefix</span>):]
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">tkn</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#a6e22e">status</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#a6e22e">codes</span>.<span style="color:#a6e22e">Unauthenticated</span>, <span style="color:#e6db74">&#34;&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">tkn</span>, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">accountIDKey</span> <span style="color:#66d9ef">struct</span> {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ContextWithAccountID å°†accountIDå†™å…¥context.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">ContextWithAccountID</span>(<span style="color:#a6e22e">c</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">aid</span> <span style="color:#a6e22e">id</span>.<span style="color:#a6e22e">AccountID</span>) <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">WithValue</span>(<span style="color:#a6e22e">c</span>, <span style="color:#a6e22e">accountIDKey</span>{}, <span style="color:#a6e22e">aid</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="2-å°†æ„é€ å¥½çš„-unaryserverinterceptor-äº¤ç»™-unaryinterceptor">2. å°†æ„é€ å¥½çš„ UnaryServerInterceptor äº¤ç»™ UnaryInterceptor</h4>
<p>æ ¹æ®è‡ªå·±çš„æƒ…å†µå®ç°ä¸Šæ–‡ä¸­çš„ <code>type tokenVerify interface {}</code>ï¼Œå¹¶æ„é€ å‡º <code>type interceptor struct {}</code>ï¼Œç„¶åæŠŠ <code>UnaryServerInterceptor</code> äº¤ç»™ <code>UnaryInterceptor</code> è·å¾— <code>ServerOption</code>ï¼š</p>
<pre tabindex="0"><code>serverOption := grpc.UnaryInterceptor(interceptor.HandleRequest)
</code></pre><h4 id="3-grpc-åœ¨-newserver-æ—¶åŠ å…¥æ‹¦æˆªå™¨é€‰é¡¹">3. gRPC åœ¨ NewServer æ—¶åŠ å…¥æ‹¦æˆªå™¨é€‰é¡¹</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">gRPCOpts</span> []<span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">ServerOption</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">gRPCOpts</span> = append(<span style="color:#a6e22e">gRPCOpts</span>, <span style="color:#a6e22e">serverOption</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">s</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">NewServer</span>(<span style="color:#a6e22e">gRPCOpts</span><span style="color:#f92672">...</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">RegisterServiceServer</span>(<span style="color:#a6e22e">s</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Service</span>{})
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Serve</span>()
</span></span></code></pre></div><p>åŠ å…¥åæ³¨å†Œè‡ªå·±çš„æœåŠ¡ï¼Œå¯åŠ¨ã€‚è¿™æ ·æˆ‘ä»¬çš„æ‹¦æˆªå™¨å°±åŠ è¿›å»äº†ï¼Œä»»ä½•è°ƒç”¨è¿™ä¸ª gRPC æœåŠ¡çš„è¯·æ±‚éƒ½ä¼šç»è¿‡è¿™ä¸ªæ‹¦æˆªå™¨çš„éªŒè¯ã€‚</p>

</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/grpc/">gRPC</a>
        
            <a href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/">å¾®æœåŠ¡</a>
        
            <a href="/tags/golang/">Golang</a>
        
    </section>


    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    <section class="article-lastmod">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



        <span>
            æœ€åæ›´æ–°äº Feb 24, 2023 02:31 CST
        </span>
    </section><script src="https://utteranc.es/client.js"
    repo="lizonglingo/lizonglingo.github.io"
    issue-term="pathname"
    label="Comment"
    theme="github-light"
    crossorigin="anonymous"
    async>
    </script>
</footer>


    
        <link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/katex.min.css"integrity="sha256-J&#43;iAE0sgH8QSz9hpcDxXIftnj65JEZgNhGcgReTTK9s="crossorigin="anonymous"
            ><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/katex.min.js"integrity="sha256-InsNdER1b2xUewP&#43;pKCUJpkhiqwHgqiPXDlIk7GzBu4="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/contrib/auto-render.min.js"integrity="sha256-y39Mpg7V3D4lhBX4x6O0bUqTV4pSrfgwEfGKfxkOdgI="crossorigin="anonymous"
                defer
                >
            </script><script>
    window.addEventListener("DOMContentLoaded", () => {
        renderMathInElement(document.querySelector(`.article-content`), {
            delimiters: [
                { left: "$$", right: "$$", display: true },
                { left: "$", right: "$", display: false },
                { left: "\\(", right: "\\)", display: false },
                { left: "\\[", right: "\\]", display: true }
            ]
        });})
</script>
    

</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">ç›¸å…³æ–‡ç« </h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="">
    <a href="/p/influxdb-go-client%E7%9A%84%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E/">
        
        

        <div class="article-details">
            <h2 class="article-title">InfluxDB Go Clientçš„ä½¿ç”¨è¯´æ˜</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/gorm%E7%9A%84%E5%B8%B8%E8%A7%81%E5%9D%91/">
        
        

        <div class="article-details">
            <h2 class="article-title">gormçš„å¸¸è§å‘</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/sinan-ml-based-and-qos-aware-resource-management-for-cloud-microservices/">
        
        

        <div class="article-details">
            <h2 class="article-title">Sinan: ML-Based and QoS-Aware Resource Management for Cloud Microservices</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/characterizing-microservice-dependency-and-performance-alibaba-trace-analysis/">
        
        

        <div class="article-details">
            <h2 class="article-title">Characterizing microservice dependency and performance: Alibaba trace analysis</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/3milebeach-a-tracer-with-teeth/">
        
        

        <div class="article-details">
            <h2 class="article-title">3MileBeach: A Tracer with Teeth</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2018 - 
        
        2023 fmt.Println(&#34;Li Duo&#34;)
    </section>
    
    <section class="powerby">
        
            è‡ªè®¤ä¸ºæ˜¯å¹»è±¡æ³¢æ™®æ˜Ÿçš„æ¥å®¢ <br/>
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        ä¸»é¢˜ <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.16.0">Stack</a></b> ç”± <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> è®¾è®¡
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
