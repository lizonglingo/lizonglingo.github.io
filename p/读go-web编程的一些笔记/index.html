<!DOCTYPE html>
<html lang="zh-CN" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content='这本书主要讲了使用golang原生的net/http包开发Web应用，后面也强调了使用goroutine和channel实现并发处理，提高W'>
<title>读《Go Web编程》的一些笔记</title>

<link rel='canonical' href='https://lizonglingo.github.io/p/%E8%AF%BBgo-web%E7%BC%96%E7%A8%8B%E7%9A%84%E4%B8%80%E4%BA%9B%E7%AC%94%E8%AE%B0/'>

<link rel="stylesheet" href="/scss/style.min.811a71d93d8df406268b1c66d015cd3f2252f454f25ac10a683e6f7b5ad9d92d.css"><meta property='og:title' content='读《Go Web编程》的一些笔记'>
<meta property='og:description' content='这本书主要讲了使用golang原生的net/http包开发Web应用，后面也强调了使用goroutine和channel实现并发处理，提高W'>
<meta property='og:url' content='https://lizonglingo.github.io/p/%E8%AF%BBgo-web%E7%BC%96%E7%A8%8B%E7%9A%84%E4%B8%80%E4%BA%9B%E7%AC%94%E8%AE%B0/'>
<meta property='og:site_name' content='Li Duo'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='Golang' /><meta property='article:tag' content='Web' /><meta property='article:published_time' content='2021-10-15T08:19:54&#43;08:00'/><meta property='article:modified_time' content='2021-10-15T08:19:54&#43;08:00'/>
<meta name="twitter:title" content="读《Go Web编程》的一些笔记">
<meta name="twitter:description" content="这本书主要讲了使用golang原生的net/http包开发Web应用，后面也强调了使用goroutine和channel实现并发处理，提高W">
    <link rel="shortcut icon" href="/favicon.ico" />

    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="切换菜单">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    <img src="https://picgo-lzl.oss-cn-beijing.aliyuncs.com/1634453613659.jpeg" width="300" height="300" class="site-logo" loading="lazy" alt="Avatar">
                
                </a>
                
                    <span class="emoji">👋</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">Li Duo</a></h1>
            <h2 class="site-description"></h2>
        </div>
    </header><ol class="social-menu">
            
                <li>
                    <a 
                        href='https://github.com/lizonglingo'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
            
        
                
                <li >
                    <a href='/' >
                        
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                        
                        <span>主页</span>
                    </a>
                </li>
                
            
        
        
            
        
                
                <li >
                    <a href='/%E5%85%B3%E4%BA%8E/' >
                        
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                        
                        <span>关于</span>
                    </a>
                </li>
                
            
        
        
            
        
                
                <li >
                    <a href='/archives/' >
                        
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                        
                        <span>归档</span>
                    </a>
                </li>
                
            
        
        
            
        
        
        
            
        
                
                <li >
                    <a href='/%E9%93%BE%E6%8E%A5/' >
                        
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                        
                        <span>链接</span>
                    </a>
                </li>
                
            
        

        <div class="menu-bottom-section">
            
            
                <li id="dark-mode-toggle">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <span>暗色模式</span>
                </li>
            
        </div>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                <form action="/search/" class="search-form widget" >
        <p>
            <label>搜索</label>
            <input name="keyword" required placeholder="输入关键词..." />
        
            <button title="搜索">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



            </button>
        </p>
    </form>
            
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">目录</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ul>
    <li><a href="#1-go与web应用">1. Go与Web应用</a>
      <ul>
        <li><a href="#go的nethttp">Go的net/http</a></li>
        <li><a href="#关于https">关于HTTPS</a></li>
      </ul>
    </li>
    <li><a href="#2-一个通用的web应用">2. 一个通用的Web应用</a>
      <ul>
        <li><a href="#使用cookie进行访问控制">使用Cookie进行访问控制</a></li>
      </ul>
    </li>
    <li><a href="#3-使用处理器和处理器函数接收请求">3. 使用处理器和处理器函数接收请求</a>
      <ul>
        <li><a href="#处理器和处理器函数">处理器和处理器函数</a></li>
        <li><a href="#串联多个处理器和处理器函数">串联多个处理器和处理器函数</a></li>
        <li><a href="#servemux和defaultservemux">ServeMux和DefaultServeMux</a></li>
      </ul>
    </li>
    <li><a href="#4-请求的处理和响应">4. 请求的处理和响应</a>
      <ul>
        <li><a href="#请求和响应">请求和响应</a></li>
        <li><a href="#从表单中获取数据">从表单中获取数据</a></li>
        <li><a href="#服务器做出响应">服务器做出响应</a></li>
        <li><a href="#cookie">Cookie</a></li>
      </ul>
    </li>
    <li><a href="#5-内容展示">5. 内容展示</a>
      <ul>
        <li><a href="#模板的语法分析">模板的语法分析</a></li>
      </ul>
    </li>
    <li><a href="#6-存储数据">6. 存储数据</a>
      <ul>
        <li><a href="#内存存储">内存存储</a></li>
        <li><a href="#csvcomma-separated-value存储">CSV（comma-separated value）存储</a></li>
        <li><a href="#encodinggob">encoding/gob</a></li>
        <li><a href="#数据库与关系映射器orm">数据库与关系映射器ORM</a></li>
      </ul>
    </li>
    <li><a href="#7-发挥go的并发优势">7. 发挥Go的并发优势</a></li>
  </ul>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/golang/" >
                Golang
            </a>
        
            <a href="/categories/web/" >
                Web
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/%E8%AF%BBgo-web%E7%BC%96%E7%A8%8B%E7%9A%84%E4%B8%80%E4%BA%9B%E7%AC%94%E8%AE%B0/">读《Go Web编程》的一些笔记</a>
        </h2>
    
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Oct 15, 2021</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    阅读时长: 15 分钟
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <blockquote>
<p>这本书主要讲了使用golang原生的<code>net/http</code>包开发Web应用，后面也强调了使用<code>goroutine</code>和<code>channel</code>实现并发处理，提高Web应用的性能。是一本比较系统的介绍Go Web开发的书。</p>
<p>本文按照全书行进章节进行一些要点的记录。</p>
</blockquote>
<h2 id="1-go与web应用">1. Go与Web应用</h2>
<ol>
<li>大规模可扩展的Web应用应具备以下特质：
<ul>
<li>可扩展：垂直扩展（提升单台设备的CPU数量和性能）、水平扩展（增加计算机的数量提高性能），go的并发编程的特点让其在垂直扩展上有优势。</li>
<li>模块化：接口实现动态类型匹配、函数闭包等，有助于模块化设计；go常用于构建微服务。</li>
<li>可维护：语法简洁可读，工具链如<code>gotest</code>较完备。</li>
<li>高性能：编译型静态代码，速度快于解释型语言，并发编程也有利于高性能。</li>
</ul>
</li>
<li>Web工作的原理：主要理解服务器与客户端的通信原理，包括HTTP、TCP/IP等协议。这里要注意，HTTP是无状态的，所以引出后面<code>cookie</code>和<code>session</code>的使用，来保存用户状态。</li>
<li>HTTP请求：要熟悉请求报文，如请求头、首部、报文主体。
<ul>
<li>请求方法：GET、POST、DELETE、HEAD、PUT等，在关于Restful API构建是，这些方法是要对应不同的服务。</li>
<li>安全请求方法：如Get、HEAD不会对服务器的状态进行修改，是安全的；而POST、PUT、DELETE会对服务器状态修改，这些方法都是不安全的。</li>
<li>幂等请求方法：就是一个HTTP方法使用相同数据进行二次调用时，不会对服务器的状态造成任何改变，那这个方法就是幂等的。所有安全请求方法都是幂等的，PUT和DELETE也是幂等的。</li>
<li>HTTP请求首部：记录了与请求本身及客户端有关的信息，许多字段如Accept、Cookie、Content-Length、Content-Type、User-Agent等，这些都是需要熟悉的。</li>
</ul>
</li>
<li>HTTP响应：是对HTTP请求报文的响应，报文包括状态行、零个和任意响应首部、可选报文主体。
<ul>
<li>响应状态码：在状态行中，有1XX、2XX、3XX、4XX、5XX五类，有不同的含义。开发中，对请求的正常或者异常的响应都有状态码是一个很好的习惯。</li>
<li>响应首部：如Content-Length、Content-Type、Set-Cookie等。</li>
</ul>
</li>
<li>HTTP/2：HTTP/1是纯文本方式、HTTP/2是二进制协议，语法分析更为高效，协议更加紧凑和健壮。HTTP 1.X一次只能发单个请求，而HTTP 2是完全多路复用的，多个请求和响应可以在同一时间内使用同一个连接，有效的提高性能。</li>
<li>Web应用通过HTTP协议，以HTTP请求报文的形式获取客户端输入-&gt;对请求报文进行处理后执行必要的操作-&gt;生成HTML以HTTP响应报文的形式返回给客户端。为了完成这些任务，Web应用可以被分为处理器Handler和模板引擎Template Engine两部分。
<ul>
<li>处理器：处理器接收请求，处理，调用模板引擎填充数据。在MVC模式看来处理器既是controller又是model。</li>
<li>模板引擎：接收处理器的数据，渲染成HTML返回给客户端。有静态模板和动态模板两种，静态模板用占位符替换成相应的数据生成HTML，动态模板除了使用占位符，还有编程语句结构，如条件语句、迭代、变量之类的。</li>
</ul>
</li>
</ol>
<h3 id="go的nethttp">Go的net/http</h3>
<p><code>net/http</code>标准库可以分为客户端和服务器两部分，有的结构和函数只支持客户端和服务器中的一个，有的则同时支持客户端和服务器。</p>
<p><img src="https://raw.githubusercontent.com/lizonglin313/MyPicGo/master/20211015112104.png"
	
	
	
	loading="lazy"
	
	
></p>
<p>一般的有两种方式配置Web服务器：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 方式一
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ListenAndServe</span>(<span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#66d9ef">nil</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 方式二 更详细的配置服务器
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">server</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Server</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Addr</span>: 			<span style="color:#e6db74">&#34;127.0.0.1:8080&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Handler</span>: 		<span style="color:#66d9ef">nil</span>,	<span style="color:#75715e">// 使用的处理器
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">ReadTimeout</span>:	<span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">server</span>.<span style="color:#a6e22e">ListenAndServe</span>()
</span></span></code></pre></div><h3 id="关于https">关于HTTPS</h3>
<p>使用HTTPS需要证书和密钥：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">server</span>.<span style="color:#a6e22e">ListenAndServeTLS</span>(<span style="color:#e6db74">&#34;cert.pem&#34;</span>, <span style="color:#e6db74">&#34;key.pem&#34;</span>)
</span></span></code></pre></div><p>其中，<code>cert.pem</code>是SSL证书，<code>key.pem</code>是服务器的私钥。<strong>实际的生产环境中使用SSL证书需要通过VeriSign、Thawte等一些CA取得</strong>。通过Go的<code>crypto</code>包可以生成证书。</p>
<h2 id="2-一个通用的web应用">2. 一个通用的Web应用</h2>
<p><img src="https://raw.githubusercontent.com/lizonglin313/MyPicGo/master/20211015111703.png"
	
	
	
	loading="lazy"
	
	
></p>
<p>一个通用的Web应用从设计开始，包括下面一些方面：</p>
<ul>
<li>使用多路复用器配置处理器、处理器函数</li>
<li>数据模型，包括数据结构、存储等</li>
<li>静态文件如HTML、CSS</li>
<li>使用cookie和session进行访问控制</li>
<li>使用模板生成HTML响应</li>
</ul>
<h3 id="使用cookie进行访问控制">使用Cookie进行访问控制</h3>
<p>用户登录成功身份经过验证后，<strong>服务器会在成功的登录请求的响应的首部中写入一个cookie，客户端在接收这个cookie后将它写入存储到浏览器中</strong>。Go中的<code>http.Cookie</code>用来构建cookie。<strong>核实用户身份后，程序在后端创建一个session，存储到数据库中，session结构中的<code>uuid</code>字段作为cookie的值，返回给客户端存储在浏览器里，之后生命周期里浏览器的请求会带着cookie，完成访问控制。</strong></p>
<p>对于cookie的生命周期一般有两类：</p>
<p><strong>会话cookie</strong>：不设置特定的过期时间，在浏览器关闭后自动移除失效。</p>
<p><strong>通过设置过期时间的cookie</strong>：比如5min后过期。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">cookie</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Cookie</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Name</span>:		<span style="color:#e6db74">&#34;_cookie&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Value</span>:		<span style="color:#a6e22e">session</span>.<span style="color:#a6e22e">Uuid</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">HttpOnly</span>:	<span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">SetCookie</span>(<span style="color:#a6e22e">writer</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">cookie</span>)	<span style="color:#75715e">// 写到响应首部
</span></span></span></code></pre></div><p><code>HttpOnly</code>字段表示该cookie只能通过HTTP/HTTPS访问，无法通过JavaScript等非HTTP API访问。</p>
<p>在后续客户端发来请求后，服务器从Request中拿到cookie的value，也就是存储在数据库中session对象的Uuid，进行比对，进而识别请求的客户端身份是否合法。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 拿到cookie进行访问控制处理
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">cookie</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Cookie</span>(<span style="color:#e6db74">&#34;_cookie&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sess</span> = <span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">Session</span>{<span style="color:#a6e22e">Uuid</span>: <span style="color:#a6e22e">cookie</span>.<span style="color:#a6e22e">Value</span>}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">sess</span>.<span style="color:#a6e22e">Check</span>()
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#a6e22e">ok</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="3-使用处理器和处理器函数接收请求">3. 使用处理器和处理器函数接收请求</h2>
<h3 id="处理器和处理器函数">处理器和处理器函数</h3>
<h4 id="处理器">处理器</h4>
<p>Go中，一个处理器就是一个拥有<code>ServeHTTP(http.ResponWriter, *http.Request)</code>方法的接口。而多路复用器<code>DefaultServerMux</code>是<code>ServeMux</code>的一个实例，后者也实现了<code>ServeHTTP</code>方法。<code>DefaultServerMux</code>既是<code>ServeMux</code>的实例，也是<code>Handler</code>结构的实例，它不仅是一个多路复用器还是一个处理器。<strong>它要做的事情就是根据请求的URL重定向到不同的处理器上</strong>。</p>
<p>当然，我们也可以编写自己的处理器去代替默认的<code>DefaultServerMux</code>。更多的时候，我们会使用多个处理器去处理指定的URL，所以常常使用服务器默认的<code>DefaultServerMux</code>做多路复用器，将不同的处理器使用<code>http.Handle</code>绑定到<code>DefaultServerMux</code>。<code>http.Handle</code><strong>实际上是</strong><code>ServeMux</code>结构的方法：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 定义一个处理器
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">HelloHandler</span> <span style="color:#66d9ef">struct</span>{}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 实现 ServeHTTP 接口
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">h</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">HelloHandler</span>) <span style="color:#a6e22e">ServeHTTP</span>(<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ResponseWriter</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// http.Handle 也做多路复用器的用途
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Handle</span>(<span style="color:#e6db74">&#34;/hello&#34;</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">hello</span>)	<span style="color:#75715e">// 传入一个处理器处理来自 /hello 的路由
</span></span></span></code></pre></div><h4 id="处理器函数">处理器函数</h4>
<p><strong>处理器函数是与处理器拥有相同行为的函数，与ServeHTTP有相同的签名</strong>。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">hello</span>(<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ResponseWriter</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">HandleFunc</span>(<span style="color:#e6db74">&#34;/hello&#34;</span>, <span style="color:#a6e22e">hello</span>)
</span></span></code></pre></div><p>实际上，Go的<code>HandlerFunc</code>函数类型，<strong>把一个处理器函数隐式的转换成一个处理器</strong>。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 源码
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 将处理器函数给默认的多路复用处理器
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">HandleFunc</span>(<span style="color:#a6e22e">pattern</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">handler</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ResponseWriter</span>, <span style="color:#f92672">*</span><span style="color:#a6e22e">Request</span>)) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">DefaultServeMux</span>.<span style="color:#a6e22e">HandleFunc</span>(<span style="color:#a6e22e">pattern</span>, <span style="color:#a6e22e">handler</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 调用 多路复用处理器的 HandleFunc 对路由绑定处理器
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">mux</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ServeMux</span>) <span style="color:#a6e22e">HandleFunc</span>(<span style="color:#a6e22e">pattern</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">handler</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ResponseWriter</span>, <span style="color:#f92672">*</span><span style="color:#a6e22e">Request</span>)) {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">handler</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		panic(<span style="color:#e6db74">&#34;http: nil handler&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">mux</span>.<span style="color:#a6e22e">Handle</span>(<span style="color:#a6e22e">pattern</span>, <span style="color:#a6e22e">HandlerFunc</span>(<span style="color:#a6e22e">handler</span>))
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// mux.Handle(pattern, HandlerFunc(handler)) 里面的 HandlerFunc() 实现了 ServeHTTP
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">HandlerFunc</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ResponseWriter</span>, <span style="color:#f92672">*</span><span style="color:#a6e22e">Request</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ServeHTTP calls f(w, r).
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">f</span> <span style="color:#a6e22e">HandlerFunc</span>) <span style="color:#a6e22e">ServeHTTP</span>(<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">ResponseWriter</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Request</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">f</span>(<span style="color:#a6e22e">w</span>, <span style="color:#a6e22e">r</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="串联多个处理器和处理器函数">串联多个处理器和处理器函数</h3>
<p>常见的Web在真正处理数据时，往往需要做一些其他工作，如：<strong>日志记录</strong>、<strong>安全检查</strong>、<strong>错误处理</strong>等。<strong>有些时候需要在处理业务的处理器前面串联上其他的处理器</strong>，又叫做<strong>管道处理</strong>。<strong>得益于Go的匿名函数</strong>、<strong>闭包</strong>这些特性，可以很好的将处理器串联起来。</p>
<h4 id="串联多个处理器函数">串联多个处理器函数</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 串联多个处理器函数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">hello</span>(<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ResponseWriter</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Fprintf</span>(<span style="color:#a6e22e">w</span>, <span style="color:#e6db74">&#34;hello&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 在处理hello前串联一个记录日志的处理器
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">h</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">HandlerFunc</span>) <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">HandlerFunc</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ResponseWriter</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 处理日志
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">h</span>(<span style="color:#a6e22e">w</span>, <span style="color:#a6e22e">r</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 在处理日志之前再串联一个验证用户身份的处理器
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">authentication</span>(<span style="color:#a6e22e">h</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">HandlerFunc</span>) <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">HandlerFunc</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ResponseWriter</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 鉴权
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">h</span>(<span style="color:#a6e22e">w</span>, <span style="color:#a6e22e">r</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// main
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">HandleFunc</span>(<span style="color:#e6db74">&#34;/hello&#34;</span>, <span style="color:#a6e22e">authentication</span>(<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">hello</span>)))
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="串联处理器">串联处理器</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">HelloHandler</span> <span style="color:#66d9ef">struct</span>{}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">h</span> <span style="color:#a6e22e">HelloHandler</span>) <span style="color:#a6e22e">ServeHTTP</span>(<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ResponseWriter</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Fprintf</span>(<span style="color:#a6e22e">w</span>, <span style="color:#e6db74">&#34;hello!&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">h</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Handler</span>) <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Handler</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">HandlerFunc</span>(<span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ResponseWriter</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;Handler called - %T\n&#34;</span>, <span style="color:#a6e22e">h</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 处理器直接显示调用ServeHTTP
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">ServeHTTP</span>(<span style="color:#a6e22e">w</span>, <span style="color:#a6e22e">r</span>)
</span></span><span style="display:flex;"><span>	})
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">authentication</span>(<span style="color:#a6e22e">h</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Handler</span>) <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Handler</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">HandlerFunc</span>(<span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ResponseWriter</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Do some protect...&#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">ServeHTTP</span>(<span style="color:#a6e22e">w</span>, <span style="color:#a6e22e">r</span>)
</span></span><span style="display:flex;"><span>	})
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Handle</span>(<span style="color:#e6db74">&#34;/hello&#34;</span>, <span style="color:#a6e22e">authentication</span>(<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">hello</span>)))
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>与串联处理器函数不同的是，<strong>串联处理器需要将匿名函数返回的函数显式的使用</strong><code>http.HandlerFunc</code>转换成<code>http.Handler</code>。在<code>main</code>中使用的也是<code>http.Handle()</code>而不是<code>http.HandleFunc()</code>了。</p>
<h3 id="servemux和defaultservemux">ServeMux和DefaultServeMux</h3>
<p><img src="https://raw.githubusercontent.com/lizonglin313/MyPicGo/master/20211015155042.png"
	
	
	
	loading="lazy"
	
	
></p>
<p>ServeMux将URL映射到响应的处理器。它也实现了<code>ServeHTTP</code>方法。</p>
<p><img src="https://raw.githubusercontent.com/lizonglin313/MyPicGo/master/20211015155320.png"
	
	
	
	loading="lazy"
	
	
></p>
<p>而DefaultServeMux是ServeMux的一个实例。开发中没有指定处理器是，Go的服务器就会用它作为默认实例。</p>
<h4 id="最小惊讶原则">最小惊讶原则</h4>
<p>从上图，假设有：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Handle</span>(<span style="color:#e6db74">&#34;/hello&#34;</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">helloHandler</span>)
</span></span></code></pre></div><p>请求的URL为<code>/hello</code>，多路复用器会分发到<code>helloHandler</code>处理，若为<code>/hello/other</code>呢？</p>
<p>答案也是一样：<code>helloHandler</code>。就类似于最长前缀匹配规则。</p>
<p>但是，如果改成：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Handle</span>(<span style="color:#e6db74">&#34;/hello/&#34;</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">helloHandler</span>)
</span></span></code></pre></div><p>匹配的路由后面也有<code>/</code>，那么只会与完全相同的<code>/hello/</code>匹配，而<code>/hello/other</code>就会匹配不到，返回错误。</p>
<h4 id="其他的处理器">其他的处理器</h4>
<p>除<code>net/http</code>包外，还有如<code>HttpRouter</code>实现的服务器，可以使用变量实现URL模式匹配，有更多丰富的功能。</p>
<h2 id="4-请求的处理和响应">4. 请求的处理和响应</h2>
<h3 id="请求和响应">请求和响应</h3>
<h4 id="request结构">Request结构</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Request</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Method</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">URL</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">url</span>.<span style="color:#a6e22e">URL</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Header</span> <span style="color:#a6e22e">Header</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Body</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">ReadCloser</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">GetBody</span> <span style="color:#66d9ef">func</span>() (<span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">ReadCloser</span>, <span style="color:#66d9ef">error</span>)	<span style="color:#75715e">// 实例化时通过匿名函数实现 GetBody
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">ContentLength</span> <span style="color:#66d9ef">int64</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">TransferEncoding</span> []<span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Close</span> <span style="color:#66d9ef">bool</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Host</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Form</span> <span style="color:#a6e22e">url</span>.<span style="color:#a6e22e">Values</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">PostForm</span> <span style="color:#a6e22e">url</span>.<span style="color:#a6e22e">Values</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">MultipartForm</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">multipart</span>.<span style="color:#a6e22e">Form</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">TLS</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">tls</span>.<span style="color:#a6e22e">ConnectionState</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Response</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Response</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="url结构">URL结构</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">URL</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Scheme</span>      <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Opaque</span>      <span style="color:#66d9ef">string</span>    <span style="color:#75715e">// encoded opaque data
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">User</span>        <span style="color:#f92672">*</span><span style="color:#a6e22e">Userinfo</span> <span style="color:#75715e">// username and password information
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Host</span>        <span style="color:#66d9ef">string</span>    <span style="color:#75715e">// host or host:port
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Path</span>        <span style="color:#66d9ef">string</span>    <span style="color:#75715e">// path (relative paths may omit leading slash)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">RawPath</span>     <span style="color:#66d9ef">string</span>    <span style="color:#75715e">// encoded path hint (see EscapedPath method)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">ForceQuery</span>  <span style="color:#66d9ef">bool</span>      <span style="color:#75715e">// append a query (&#39;?&#39;) even if RawQuery is empty
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">RawQuery</span>    <span style="color:#66d9ef">string</span>    <span style="color:#75715e">// encoded query values, without &#39;?&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Fragment</span>    <span style="color:#66d9ef">string</span>    <span style="color:#75715e">// fragment for references, without &#39;#&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">RawFragment</span> <span style="color:#66d9ef">string</span>    <span style="color:#75715e">// encoded fragment hint (see EscapedFragment method)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><h4 id="请求首部">请求首部</h4>
<p>一个请求的Demo：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-http" data-lang="http"><span style="display:flex;"><span><span style="color:#a6e22e">GET</span> / <span style="color:#66d9ef">HTTP</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1.1</span>
</span></span><span style="display:flex;"><span>Host<span style="color:#f92672">:</span> <span style="color:#ae81ff">hackr.jp</span>
</span></span><span style="display:flex;"><span>User-Agent<span style="color:#f92672">:</span> <span style="color:#ae81ff">Mozilla/5.0 (Windows NT 6.1; WOW64; rv:13.0) Gecko/20100101 Firefox/13.0</span>
</span></span><span style="display:flex;"><span>Accept<span style="color:#f92672">:</span> <span style="color:#ae81ff">text/html,application/xhtml+xml,application/xml;q=0.9,*/*; q=0.8</span>
</span></span><span style="display:flex;"><span>Accept-Language<span style="color:#f92672">:</span> <span style="color:#ae81ff">ja,en-us;q=0.7,en;q=0.3</span>
</span></span><span style="display:flex;"><span>Accept-Encoding<span style="color:#f92672">:</span> <span style="color:#ae81ff">gzip, deflate DNT: 1</span>
</span></span><span style="display:flex;"><span>Connection<span style="color:#f92672">:</span> <span style="color:#ae81ff">keep-alive</span>
</span></span><span style="display:flex;"><span>If-Modified-Since<span style="color:#f92672">:</span> <span style="color:#ae81ff">Fri, 31 Aug 2007 02:02:20 GMT</span>
</span></span><span style="display:flex;"><span>If-None-Match<span style="color:#f92672">:</span> <span style="color:#ae81ff">&#34;45bae1-16a-46d776ac&#34;</span>
</span></span><span style="display:flex;"><span>Cache-Control<span style="color:#f92672">:</span> <span style="color:#ae81ff">max-age=0</span>
</span></span></code></pre></div><p>Go拿到的是这样的：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// http.Request
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">&amp;</span>{<span style="color:#a6e22e">GET</span> <span style="color:#f92672">/</span><span style="color:#a6e22e">body</span> <span style="color:#a6e22e">HTTP</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1.1</span> <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">map</span>[<span style="color:#a6e22e">Accept</span>:[<span style="color:#a6e22e">text</span><span style="color:#f92672">/</span><span style="color:#a6e22e">html</span>,<span style="color:#a6e22e">application</span><span style="color:#f92672">/</span><span style="color:#a6e22e">xhtml</span><span style="color:#f92672">+</span><span style="color:#a6e22e">xml</span>,<span style="color:#a6e22e">application</span><span style="color:#f92672">/</span><span style="color:#a6e22e">xml</span>;<span style="color:#a6e22e">q</span>=<span style="color:#ae81ff">0.9</span>,<span style="color:#a6e22e">image</span><span style="color:#f92672">/</span><span style="color:#a6e22e">webp</span>,<span style="color:#a6e22e">image</span><span style="color:#f92672">/</span><span style="color:#a6e22e">apng</span>,<span style="color:#f92672">*/*</span>;<span style="color:#a6e22e">q</span>=<span style="color:#ae81ff">0.8</span>,<span style="color:#a6e22e">application</span><span style="color:#f92672">/</span><span style="color:#a6e22e">signed</span><span style="color:#f92672">-</span><span style="color:#a6e22e">exchange</span>;<span style="color:#a6e22e">v</span>=<span style="color:#a6e22e">b3</span>;<span style="color:#a6e22e">q</span>=<span style="color:#ae81ff">0.9</span>] <span style="color:#a6e22e">Accept</span><span style="color:#f92672">-</span><span style="color:#a6e22e">Encoding</span>:[<span style="color:#a6e22e">gzip</span>, <span style="color:#a6e22e">deflate</span>, <span style="color:#a6e22e">br</span>] <span style="color:#a6e22e">Accept</span><span style="color:#f92672">-</span><span style="color:#a6e22e">Language</span>:[<span style="color:#a6e22e">zh</span><span style="color:#f92672">-</span><span style="color:#a6e22e">CN</span>,<span style="color:#a6e22e">zh</span>;<span style="color:#a6e22e">q</span>=<span style="color:#ae81ff">0.9</span>,<span style="color:#a6e22e">en</span>;<span style="color:#a6e22e">q</span>=<span style="color:#ae81ff">0.8</span>,<span style="color:#a6e22e">en</span><span style="color:#f92672">-</span><span style="color:#a6e22e">GB</span>;<span style="color:#a6e22e">q</span>=<span style="color:#ae81ff">0.7</span>,<span style="color:#a6e22e">en</span><span style="color:#f92672">-</span><span style="color:#a6e22e">US</span>;<span style="color:#a6e22e">q</span>=<span style="color:#ae81ff">0.6</span>] <span style="color:#a6e22e">Cache</span><span style="color:#f92672">-</span><span style="color:#a6e22e">Control</span>:[<span style="color:#a6e22e">max</span><span style="color:#f92672">-</span><span style="color:#a6e22e">age</span>=<span style="color:#ae81ff">0</span>] <span style="color:#a6e22e">Connection</span>:[<span style="color:#a6e22e">keep</span><span style="color:#f92672">-</span><span style="color:#a6e22e">alive</span>] <span style="color:#a6e22e">Cookie</span>:[<span style="color:#a6e22e">csrftoken</span>=<span style="color:#a6e22e">AFpbq4QNxdr35oU4SgESrmHLGtgbjLIUrDIkod4ZjsQIq1hynjiMRYphYluqomNE</span>] <span style="color:#a6e22e">Sec</span><span style="color:#f92672">-</span><span style="color:#a6e22e">Ch</span><span style="color:#f92672">-</span><span style="color:#a6e22e">Ua</span>:[<span style="color:#e6db74">&#34;Chromium&#34;</span>;<span style="color:#a6e22e">v</span>=<span style="color:#e6db74">&#34;94&#34;</span>, <span style="color:#e6db74">&#34;Microsoft Edge&#34;</span>;<span style="color:#a6e22e">v</span>=<span style="color:#e6db74">&#34;94&#34;</span>, <span style="color:#e6db74">&#34;;Not A Brand&#34;</span>;<span style="color:#a6e22e">v</span>=<span style="color:#e6db74">&#34;99&#34;</span>] <span style="color:#a6e22e">Sec</span><span style="color:#f92672">-</span><span style="color:#a6e22e">Ch</span><span style="color:#f92672">-</span><span style="color:#a6e22e">Ua</span><span style="color:#f92672">-</span><span style="color:#a6e22e">Mobile</span>:[<span style="color:#960050;background-color:#1e0010">?</span><span style="color:#ae81ff">0</span>] <span style="color:#a6e22e">Sec</span><span style="color:#f92672">-</span><span style="color:#a6e22e">Ch</span><span style="color:#f92672">-</span><span style="color:#a6e22e">Ua</span><span style="color:#f92672">-</span><span style="color:#a6e22e">Platform</span>:[<span style="color:#e6db74">&#34;Windows&#34;</span>] <span style="color:#a6e22e">Sec</span><span style="color:#f92672">-</span><span style="color:#a6e22e">Fetch</span><span style="color:#f92672">-</span><span style="color:#a6e22e">Dest</span>:[<span style="color:#a6e22e">document</span>] <span style="color:#a6e22e">Sec</span><span style="color:#f92672">-</span><span style="color:#a6e22e">Fetch</span><span style="color:#f92672">-</span><span style="color:#a6e22e">Mode</span>:[<span style="color:#a6e22e">navigate</span>] <span style="color:#a6e22e">Sec</span><span style="color:#f92672">-</span><span style="color:#a6e22e">Fetch</span><span style="color:#f92672">-</span><span style="color:#a6e22e">Site</span>:[<span style="color:#a6e22e">none</span>] <span style="color:#a6e22e">Sec</span><span style="color:#f92672">-</span><span style="color:#a6e22e">Fetch</span><span style="color:#f92672">-</span><span style="color:#a6e22e">User</span>:[<span style="color:#960050;background-color:#1e0010">?</span><span style="color:#ae81ff">1</span>] <span style="color:#a6e22e">Upgrade</span><span style="color:#f92672">-</span><span style="color:#a6e22e">Insecure</span><span style="color:#f92672">-</span><span style="color:#a6e22e">Requests</span>:[<span style="color:#ae81ff">1</span>] <span style="color:#a6e22e">User</span><span style="color:#f92672">-</span><span style="color:#a6e22e">Agent</span>:[<span style="color:#a6e22e">Mozilla</span><span style="color:#f92672">/</span><span style="color:#ae81ff">5.0</span> (<span style="color:#a6e22e">Windows</span> <span style="color:#a6e22e">NT</span> <span style="color:#ae81ff">10.0</span>; <span style="color:#a6e22e">Win64</span>; <span style="color:#a6e22e">x64</span>) <span style="color:#a6e22e">AppleWebKit</span><span style="color:#f92672">/</span><span style="color:#ae81ff">537.36</span> (<span style="color:#a6e22e">KHTML</span>, <span style="color:#a6e22e">like</span> <span style="color:#a6e22e">Gecko</span>) <span style="color:#a6e22e">Chrome</span><span style="color:#f92672">/</span><span style="color:#ae81ff">94.0.4606.81</span> <span style="color:#a6e22e">Safari</span><span style="color:#f92672">/</span><span style="color:#ae81ff">537.36</span> <span style="color:#a6e22e">Edg</span><span style="color:#f92672">/</span><span style="color:#ae81ff">94.0.992.47</span>]] {} &lt;<span style="color:#66d9ef">nil</span>&gt; <span style="color:#ae81ff">0</span> [] <span style="color:#66d9ef">false</span> <span style="color:#ae81ff">127.0.0.1</span>:<span style="color:#ae81ff">8080</span> <span style="color:#66d9ef">map</span>[] <span style="color:#66d9ef">map</span>[] &lt;<span style="color:#66d9ef">nil</span>&gt; <span style="color:#66d9ef">map</span>[] <span style="color:#ae81ff">127.0.0.1</span>:<span style="color:#ae81ff">64798</span> <span style="color:#f92672">/</span><span style="color:#a6e22e">body</span> &lt;<span style="color:#66d9ef">nil</span>&gt; &lt;<span style="color:#66d9ef">nil</span>&gt; &lt;<span style="color:#66d9ef">nil</span>&gt; <span style="color:#ae81ff">0xc0000f42c0</span>}
</span></span></code></pre></div><p>请求体是一个<code>map</code>结构的数据，比如：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">map</span>[
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Accept</span>:[<span style="color:#a6e22e">text</span><span style="color:#f92672">/</span><span style="color:#a6e22e">html</span>,<span style="color:#a6e22e">application</span><span style="color:#f92672">/</span><span style="color:#a6e22e">xhtml</span><span style="color:#f92672">+</span><span style="color:#a6e22e">xml</span>,<span style="color:#a6e22e">application</span><span style="color:#f92672">/</span><span style="color:#a6e22e">xml</span>;<span style="color:#a6e22e">q</span>=<span style="color:#ae81ff">0.9</span>,<span style="color:#a6e22e">image</span><span style="color:#f92672">/</span><span style="color:#a6e22e">webp</span>,<span style="color:#a6e22e">image</span><span style="color:#f92672">/</span><span style="color:#a6e22e">apng</span>,<span style="color:#f92672">*/*</span>;<span style="color:#a6e22e">q</span>=<span style="color:#ae81ff">0.8</span>,<span style="color:#a6e22e">application</span><span style="color:#f92672">/</span><span style="color:#a6e22e">signed</span><span style="color:#f92672">-</span><span style="color:#a6e22e">exchange</span>;<span style="color:#a6e22e">v</span>=<span style="color:#a6e22e">b3</span>;<span style="color:#a6e22e">q</span>=<span style="color:#ae81ff">0.9</span>] 
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Accept</span><span style="color:#f92672">-</span><span style="color:#a6e22e">Encoding</span>:[<span style="color:#a6e22e">gzip</span>, <span style="color:#a6e22e">deflate</span>, <span style="color:#a6e22e">br</span>] 
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Accept</span><span style="color:#f92672">-</span><span style="color:#a6e22e">Language</span>:[<span style="color:#a6e22e">zh</span><span style="color:#f92672">-</span><span style="color:#a6e22e">CN</span>,<span style="color:#a6e22e">zh</span>;<span style="color:#a6e22e">q</span>=<span style="color:#ae81ff">0.9</span>,<span style="color:#a6e22e">en</span>;<span style="color:#a6e22e">q</span>=<span style="color:#ae81ff">0.8</span>,<span style="color:#a6e22e">en</span><span style="color:#f92672">-</span><span style="color:#a6e22e">GB</span>;<span style="color:#a6e22e">q</span>=<span style="color:#ae81ff">0.7</span>,<span style="color:#a6e22e">en</span><span style="color:#f92672">-</span><span style="color:#a6e22e">US</span>;<span style="color:#a6e22e">q</span>=<span style="color:#ae81ff">0.6</span>] 
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Cache</span><span style="color:#f92672">-</span><span style="color:#a6e22e">Control</span>:[<span style="color:#a6e22e">max</span><span style="color:#f92672">-</span><span style="color:#a6e22e">age</span>=<span style="color:#ae81ff">0</span>] 
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Connection</span>:[<span style="color:#a6e22e">keep</span><span style="color:#f92672">-</span><span style="color:#a6e22e">alive</span>] 
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Cookie</span>:[<span style="color:#a6e22e">csrftoken</span>=<span style="color:#a6e22e">AFpbq4uy3rn35oU4SkESrmHLGwvqjLIjuDIkod4ZjsQIq1uknHiMRYphYluqomNE</span>] 
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">...</span>.
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Upgrade</span><span style="color:#f92672">-</span><span style="color:#a6e22e">Insecure</span><span style="color:#f92672">-</span><span style="color:#a6e22e">Requests</span>:[<span style="color:#ae81ff">1</span>] 
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">User</span><span style="color:#f92672">-</span><span style="color:#a6e22e">Agent</span>:[<span style="color:#a6e22e">Mozilla</span><span style="color:#f92672">/</span><span style="color:#ae81ff">5.0</span> (<span style="color:#a6e22e">Windows</span> <span style="color:#a6e22e">NT</span> <span style="color:#ae81ff">10.0</span>; <span style="color:#a6e22e">Win64</span>; <span style="color:#a6e22e">x64</span>) <span style="color:#a6e22e">AppleWebKit</span><span style="color:#f92672">/</span><span style="color:#ae81ff">537.36</span> (<span style="color:#a6e22e">KHTML</span>, <span style="color:#a6e22e">like</span> <span style="color:#a6e22e">Gecko</span>) <span style="color:#a6e22e">Chrome</span><span style="color:#f92672">/</span><span style="color:#ae81ff">94.0.4606.81</span> <span style="color:#a6e22e">Safari</span><span style="color:#f92672">/</span><span style="color:#ae81ff">537.36</span> <span style="color:#a6e22e">Edg</span><span style="color:#f92672">/</span><span style="color:#ae81ff">94.0.992.47</span>]
</span></span><span style="display:flex;"><span>]
</span></span></code></pre></div><p>可以通过：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Header</span>[<span style="color:#e6db74">&#34;key&#34;</span>]
</span></span><span style="display:flex;"><span><span style="color:#75715e">// or
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Header</span>.<span style="color:#a6e22e">Get</span>(<span style="color:#e6db74">&#34;key&#34;</span>)
</span></span></code></pre></div><p>拿到请求首部数据。</p>
<h4 id="请求主体">请求主体</h4>
<p>**一般的，GET请求没有Body内容，只有使用POST方式提交的请求才有Body。**而GET方式传递的数据放在URL中以键值对的形式进行传递。</p>
<p>这是一个POST请求的Demo：</p>
<p><img src="https://raw.githubusercontent.com/lizonglin313/MyPicGo/master/20211015170911.png"
	
	
	
	loading="lazy"
	
	
></p>
<p>请求中用户发送的数据是服务端所需要的。一般的，这些数据都是从表单中获取的。</p>
<h3 id="从表单中获取数据">从表单中获取数据</h3>
<p>需要注意的是，<strong>HTML表单的数据类型决定了POST在发送键值对时使用什么样的格式</strong>。</p>
<div class="table-wrapper"><table>
<thead>
<tr>
<th style="text-align:left">值</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">application/x-www-form-urlencoded</td>
<td style="text-align:left">默认的，浏览器在发送前将所有提交的数据编码成长字符串，不同的键值对用“&amp;”隔开，如：first_name=li&amp;last_name=duo。这种编码更加简单和高效。</td>
</tr>
<tr>
<td style="text-align:left">multipart/form-data</td>
<td style="text-align:left">表单的数据转换成MIME报文。在使用包含文件上传控件的表单时，必须使用该值。</td>
</tr>
<tr>
<td style="text-align:left">text/plain</td>
<td style="text-align:left">空格转换为 &ldquo;+&rdquo; 加号，但不对特殊字符编码。</td>
</tr>
</tbody>
</table></div>
<p>设<code>r</code>是一个<code>http.Request</code>，获取数据的方式有：</p>
<p><img src="https://raw.githubusercontent.com/lizonglin313/MyPicGo/master/20211015175001.png"
	
	
	
	loading="lazy"
	
	
></p>
<h4 id="关于文件">关于文件</h4>
<p>从Form中拿到文件需要<code>r.ParseMultipartForm</code>和<code>r.MultipartForm.File</code>来获取。</p>
<h3 id="服务器做出响应">服务器做出响应</h3>
<p><strong>服务器给客户端返回响应使用的是</strong><code>http.ResponseWriter</code>，<strong>在创建响应时使用了</strong><code>http.response</code>。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">ResponseWriter</span> <span style="color:#66d9ef">interface</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Header</span>() <span style="color:#a6e22e">Header</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Write</span>([]<span style="color:#66d9ef">byte</span>) (<span style="color:#66d9ef">int</span>, <span style="color:#66d9ef">error</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">WriteHeader</span>(<span style="color:#a6e22e">statusCode</span> <span style="color:#66d9ef">int</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// http.response 是不可导出的
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">response</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">conn</span>             <span style="color:#f92672">*</span><span style="color:#a6e22e">conn</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">req</span>              <span style="color:#f92672">*</span><span style="color:#a6e22e">Request</span> 
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">reqBody</span>          <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">ReadCloser</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">w</span>  <span style="color:#f92672">*</span><span style="color:#a6e22e">bufio</span>.<span style="color:#a6e22e">Writer</span> 
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">handlerHeader</span> <span style="color:#a6e22e">Header</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">calledHeader</span>  <span style="color:#66d9ef">bool</span> 
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">written</span>       <span style="color:#66d9ef">int64</span> 
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">contentLength</span> <span style="color:#66d9ef">int64</span> 
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">status</span>        <span style="color:#66d9ef">int</span>   
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>这里有一个值得注意的地方：ServerHTTP中，为什么</strong><code>http.ResponseWriter</code><strong>传值</strong>，<strong>而</strong><code>http.Request</code><strong>是以指针引用方式传递的呢？</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Handler</span> <span style="color:#66d9ef">interface</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">ServeHTTP</span>(<span style="color:#a6e22e">ResponseWriter</span>, <span style="color:#f92672">*</span><span style="color:#a6e22e">Request</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>首先，<code>*http.Request</code>使用指针传递引用是因为：服务器需要察觉我们对<code>Request</code>结构的修改，所以必须要传引用。那服务器不用察觉<code>Response</code>的修改吗？也用。</p>
<p>所以，在<code>http.ResponseWriter</code>接口的实现<code>response</code>中，<code>response</code>是以引用传递的。可以理解为，<code>http.ResponseWriter</code>中是<code>*response</code>。所以实际上，传递的还是引用。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">w</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">response</span>) <span style="color:#a6e22e">Header</span>() <span style="color:#a6e22e">Header</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">cw</span>.<span style="color:#a6e22e">header</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">wroteHeader</span> <span style="color:#f92672">&amp;&amp;</span> !<span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">cw</span>.<span style="color:#a6e22e">wroteHeader</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Accessing the header between logically writing it
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// and physically writing it means we need to allocate
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// a clone to snapshot the logically written state.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">cw</span>.<span style="color:#a6e22e">header</span> = <span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">handlerHeader</span>.<span style="color:#a6e22e">Clone</span>()
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">calledHeader</span> = <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">handlerHeader</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>可以看到，<code>response</code>在实现<code>http.ResponseWriter</code>接口时，是以引用的方式。</p>
<p>有多种方法可以对<code>ResponseWriter</code>进行写入：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 使用 write 方法将数据写入 http Respons body中
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">write</span>(<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ResponseWriter</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">str</span> <span style="color:#f92672">:=</span> <span style="color:#e6db74">&#34;info&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">Write</span>([]byte(<span style="color:#a6e22e">str</span>))
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 对 Response header 进行设置 如状态码等信息
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// @Notice:	WriteHeader 执行完毕后 不允许再写入信息了
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">header</span>(<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ResponseWriter</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 设置 Location 实现 重定向页面
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">Header</span>().<span style="color:#a6e22e">Set</span>(<span style="color:#e6db74">&#34;Location&#34;</span>, <span style="color:#e6db74">&#34;https://lizonglin313.github.io/&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">Header</span>().<span style="color:#a6e22e">Set</span>(<span style="color:#e6db74">&#34;A&#34;</span>, <span style="color:#e6db74">&#34;aaa&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">WriteHeader</span>(<span style="color:#ae81ff">302</span>)	<span style="color:#75715e">// 写入状态码
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 向响应中写入 JSON 格式的数据
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// @Notice:	要首先 使用 Header 将相应的内容 设置为 JSON 格式
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">outputJSON</span>(<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ResponseWriter</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">Header</span>().<span style="color:#a6e22e">Set</span>(<span style="color:#e6db74">&#34;Content-Type&#34;</span>, <span style="color:#e6db74">&#34;application/json&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">post</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Post</span>{	<span style="color:#75715e">// Post 是一个实现打好 JSON Tag的结构体
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">User</span>:    <span style="color:#e6db74">&#34;lzl&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Threads</span>: []<span style="color:#66d9ef">string</span>{<span style="color:#e6db74">&#34;1&#34;</span>, <span style="color:#e6db74">&#34;2&#34;</span>, <span style="color:#e6db74">&#34;3&#34;</span>},
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">jsonByte</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">json</span>.<span style="color:#a6e22e">Marshal</span>(<span style="color:#a6e22e">post</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">Write</span>(<span style="color:#a6e22e">jsonByte</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="cookie">Cookie</h3>
<p>cookie常用于客户端持久化场景中，当<strong>客户端向服务器发出一个HTTP请求时，cookie会随着一起被发到服务器</strong>。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Cookie</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Name</span>  <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Value</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Path</span>       <span style="color:#66d9ef">string</span>    <span style="color:#75715e">// optional
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Domain</span>     <span style="color:#66d9ef">string</span>    <span style="color:#75715e">// optional
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Expires</span>    <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Time</span> <span style="color:#75715e">// optional
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">RawExpires</span> <span style="color:#66d9ef">string</span>    <span style="color:#75715e">// for reading cookies only
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// MaxAge=0 表示cookie在浏览器关闭后失效
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// MaxAge&lt;0 意味着cookie已经过期，客户端浏览器需要立马移除cookie
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// MaxAge&gt;0 意味cookie可以存活多少秒
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">MaxAge</span>   <span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Secure</span>   <span style="color:#66d9ef">bool</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">HttpOnly</span> <span style="color:#66d9ef">bool</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">SameSite</span> <span style="color:#a6e22e">SameSite</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Raw</span>      <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Unparsed</span> []<span style="color:#66d9ef">string</span> <span style="color:#75715e">// Raw text of unparsed attribute-value pairs
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><p>一般的，没有设置<code>Expires</code>的cookie成为会话cookie，这种cookie在浏览器关闭时被自动移除；相反的，设置了的cookie称为持久cookie。<code>Expires</code>明确指明cookie在什么时间点过期，而<code>MaxAge</code>则表示过多久cookie会过期。</p>
<h4 id="向浏览器设置cookie">向浏览器设置cookie</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">c1</span> = <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Cookie</span>{<span style="color:#f92672">...</span>}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">c2</span> = <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Cookie</span>{<span style="color:#f92672">...</span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 方法一：向Header中设置，注意第二个cookie需要你使用 Add 追加 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">Header</span>().<span style="color:#a6e22e">Set</span>(<span style="color:#e6db74">&#34;Set-Cookie&#34;</span>, <span style="color:#a6e22e">c1</span>.<span style="color:#a6e22e">String</span>())
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">Header</span>().<span style="color:#a6e22e">Add</span>(<span style="color:#e6db74">&#34;Set-Cookie&#34;</span>, <span style="color:#a6e22e">c2</span>.<span style="color:#a6e22e">String</span>())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 方法二：使用http.SetCookie() 方法直接设置
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// 这种设置多个cookie时就不需要 Add 了
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">SetCookie</span>(<span style="color:#a6e22e">w</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">c1</span>)
</span></span></code></pre></div><h4 id="从浏览器获取cookie">从浏览器获取cookie</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 方法一：直接在Header拿
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">cookie</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Header</span>[<span style="color:#e6db74">&#34;Cookie&#34;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 方法二：使用 Cookie(&#34;key&#34;) 方法，只能拿到cookie列表中的键值为 key 的cookie值
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">cookie</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Cookie</span>(<span style="color:#e6db74">&#34;first_cookie&#34;</span>)	<span style="color:#75715e">// r.Cookie 返回一个 cookie 指针
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 方法三：使用 Cookies() 方法拿到cookie列表，获得所有cookie
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">cs</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Cookies</span>()	<span style="color:#75715e">// r.Cookies 返回一个 cookie 的指针切片
</span></span></span></code></pre></div><h4 id="闪现消息">闪现消息</h4>
<p>上文中提到：cookie的<code>MaxAge&lt;0</code> 意味着cookie已经过期，客户端浏览器需要立马移除cookie。通过这个性质可以实现类似弹出框的闪现消息。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 将 某个 cookie 的生存时间 置为 负
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// 当再次请求这个处理器后，将找不到 cookie key
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">showMessage</span>(<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ResponseWriter</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">c</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Cookie</span>(<span style="color:#e6db74">&#34;key&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ErrNoCookie</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Fprintln</span>(<span style="color:#a6e22e">w</span>, <span style="color:#e6db74">&#34;No message found!&#34;</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">rc</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Cookie</span>{
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Name</span>: <span style="color:#e6db74">&#34;key&#34;</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">MaxAge</span>: <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Expires</span>: <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Unix</span>(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>),
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">SetCookie</span>(<span style="color:#a6e22e">w</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">rc</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Fprintln</span>(<span style="color:#a6e22e">w</span>, <span style="color:#e6db74">`If you refresh the page, you&#39;ll see &#34;No message found!&#34;`</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="5-内容展示">5. 内容展示</h2>
<p>Go的模板引擎通过将数据和模板组合在一起，生成最终的HTML返回给浏览器。通常模板引擎有两种类型：</p>
<ul>
<li>无逻辑模板引擎：在模板中使用占位符，在填充数据时仅仅使用字符串替换。</li>
<li>嵌入逻辑的模板引擎：在模板中还会有逻辑代码，更灵活，更强大，能处理数据逻辑。</li>
</ul>
<p>Go的模板引擎是介于无逻辑模板引擎和嵌入逻辑模板引擎之间的一种模板引擎。分别在<code>text/template</code>中和<code>html/template</code>中，来处理任意格式的文本数据和HTML格式。</p>
<p>使用Go的Web模板需要两个步骤：</p>
<ol>
<li>对文本格式的模板进行语法分析，创建一个经过语法分析的模板结构。</li>
<li>将<code>ResponseWriter</code>和模板所需的动态数据传递给模板引擎，生成HTML，然后再返回给<code>ResponseWriter</code>。</li>
</ol>
<p>例如：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">process</span>(<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ResponseWriter</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 模板文件这里需要写路径，而且路径最前面不加 /
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">t</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">template</span>.<span style="color:#a6e22e">ParseFiles</span>(<span style="color:#e6db74">&#34;go_web_Sau/day2/template/templates/temp1.html&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 生成数据
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">data</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">CreateData</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 将数据写到模板中
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Execute</span>(<span style="color:#a6e22e">w</span>, <span style="color:#a6e22e">data</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="模板的语法分析">模板的语法分析</h3>
<p>上面的代码中，执行了：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">t</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">template</span>.<span style="color:#a6e22e">ParseFiles</span>(<span style="color:#e6db74">&#34;filepath&#34;</span>)
</span></span></code></pre></div><p>这实际上执行了两个动作，首先使用文件创建出一个新模板，然后再解析它：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">t</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">template</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;filename&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">t</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">ParseFiles</span>(<span style="color:#e6db74">&#34;filepath&#34;</span>)
</span></span></code></pre></div><p><strong>使用这种两步的方法需要注意的是</strong>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">t</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">template</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;temp6.html&#34;</span>).<span style="color:#a6e22e">Funcs</span>(<span style="color:#a6e22e">funcMap</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">t</span>,  <span style="color:#a6e22e">_</span> = <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">ParseFiles</span>(<span style="color:#e6db74">&#34;go_web_Sau/day2/template/templates/temp6.html&#34;</span>)
</span></span></code></pre></div><p><code>New()</code>函数后面，只能跟模板名字，而<code>ParseFiles()</code>中需要的是从项目根路径开始的一个路径。</p>
<p>其中，<code>ParseFiles()</code>可以<strong>接收多个文件名，但是这种情况下只会返回第一个文件的模板，至于其他的模板会放到一个映射里</strong>。</p>
<p>Go的模板中，可以包含下面几种动作：</p>
<ul>
<li>条件动作，对传入的数据做条件判断</li>
<li>迭代动作，对数据进行遍历</li>
<li>设置动作，在模板中对数据赋值</li>
<li>包含动作，模板可以相互调用</li>
</ul>
<p>此外，在模板中还可以使用：</p>
<ul>
<li>管道</li>
<li>为模板绑定函数</li>
<li>对于不同的如HTML语法、text格式进行上下文感知，例如对将Javascript脚本转译成可读字符串从而避免XSS攻击</li>
</ul>
<blockquote>
<p>更多关于Go template的内容：</p>
<p><a class="link" href="https://www.liwenzhou.com/posts/Go/go_template/"  target="_blank" rel="noopener"
    >Go语言标准库之http/template | 李文周的博客 (liwenzhou.com)</a></p>
<p><a class="link" href="https://github.com/lizonglin313/AdvancedGo/tree/main/go_web_Sau/day2/template"  target="_blank" rel="noopener"
    >本部分内容的源码Demo-AdvancedGo/go_web_Sau/day2/template at main · lizonglin313/AdvancedGo (github.com)</a></p>
</blockquote>
<h2 id="6-存储数据">6. 存储数据</h2>
<p>本书的存储模板主要是：</p>
<ul>
<li>内存存储</li>
<li>CSV存储</li>
<li>使用<code>gob</code>包进行二进制存储</li>
<li>使用数据库和数据库关系映射器</li>
</ul>
<p>一般的，Web应用对于数据的存储有三种：</p>
<ul>
<li>将数据暂存到内存中</li>
<li>生成数据文件，将数据存入文件中</li>
<li>使用数据库进行持久化存储</li>
</ul>
<h3 id="内存存储">内存存储</h3>
<p>内存存储不需要访问磁盘，所以一般来说速度是最快的。<strong>但是内存存储的数据不是持久化的</strong>，在程序关闭后数据就会丢失。</p>
<p>使用内存存储无非就是用Go的数据结构，如Array、Slice、Map等结构，也可使是扩展的Stack、Queue、Tree等。</p>
<p>在使用内存存储，尤其涉及到数据修改的时候，<strong>要着重注意是传递指针引用还是直接传值</strong>。</p>
<h3 id="csvcomma-separated-value存储">CSV（comma-separated value）存储</h3>
<p>也就是逗号分隔符存储，像这样：</p>
<p><img src="https://raw.githubusercontent.com/lizonglin313/MyPicGo/master/20211016151116.png"
	
	
	
	loading="lazy"
	
	
></p>
<p>使用CSV进行存储时，需要把数据转化成字符串：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">writer</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">csv</span>.<span style="color:#a6e22e">NewWriter</span>(<span style="color:#a6e22e">csvFile</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">post</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">allPosts</span> {
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">line</span> <span style="color:#f92672">:=</span> []<span style="color:#66d9ef">string</span>{<span style="color:#a6e22e">strconv</span>.<span style="color:#a6e22e">Itoa</span>(<span style="color:#a6e22e">post</span>.<span style="color:#a6e22e">Id</span>), <span style="color:#a6e22e">post</span>.<span style="color:#a6e22e">Content</span>, <span style="color:#a6e22e">post</span>.<span style="color:#a6e22e">Author</span>}	<span style="color:#75715e">// 转换成字符串的切片
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">writer</span>.<span style="color:#a6e22e">Write</span>(<span style="color:#a6e22e">line</span>)	<span style="color:#75715e">// 实际上写入一个buffer
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>      panic(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">writer</span>.<span style="color:#a6e22e">Flush</span>()	<span style="color:#75715e">// 最后再将buffer写入文件
</span></span></span></code></pre></div><h3 id="encodinggob">encoding/gob</h3>
<p>这个包用于管理gob组成的流，这是一种在编码器和解码器之间进行交流的一种二进制数据。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">store</span>(<span style="color:#a6e22e">data</span> <span style="color:#66d9ef">interface</span>{}, <span style="color:#a6e22e">filename</span> <span style="color:#66d9ef">string</span>) {
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">// 创建 缓冲区
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   <span style="color:#a6e22e">buffer</span> <span style="color:#f92672">:=</span> new(<span style="color:#a6e22e">bytes</span>.<span style="color:#a6e22e">Buffer</span>)
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">// 创建 编码器 向缓冲区写
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   <span style="color:#a6e22e">encoder</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">gob</span>.<span style="color:#a6e22e">NewEncoder</span>(<span style="color:#a6e22e">buffer</span>)
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">// 编码数据 写道 缓冲区 data -&gt; buffer
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">encoder</span>.<span style="color:#a6e22e">Encode</span>(<span style="color:#a6e22e">data</span>)
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>      panic(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">// 将 缓冲区数据 写到 文件
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">ioutil</span>.<span style="color:#a6e22e">WriteFile</span>(<span style="color:#a6e22e">filename</span>, <span style="color:#a6e22e">buffer</span>.<span style="color:#a6e22e">Bytes</span>(), <span style="color:#ae81ff">0600</span>)
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>      panic(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">load</span>(<span style="color:#a6e22e">data</span> <span style="color:#66d9ef">interface</span>{}, <span style="color:#a6e22e">filename</span> <span style="color:#66d9ef">string</span>) {
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">// 从 文件中 读取原始数据
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   <span style="color:#a6e22e">raw</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ioutil</span>.<span style="color:#a6e22e">ReadFile</span>(<span style="color:#a6e22e">filename</span>)
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>      panic(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">// 创建缓冲区 将原始数据写到缓冲区 raw -&gt; buffer
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   <span style="color:#a6e22e">buffer</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">bytes</span>.<span style="color:#a6e22e">NewBuffer</span>(<span style="color:#a6e22e">raw</span>)
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">// 为 缓冲区 创建 解码器
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   <span style="color:#a6e22e">dec</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">gob</span>.<span style="color:#a6e22e">NewDecoder</span>(<span style="color:#a6e22e">buffer</span>)
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">dec</span>.<span style="color:#a6e22e">Decode</span>(<span style="color:#a6e22e">data</span>)
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>      panic(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="数据库与关系映射器orm">数据库与关系映射器ORM</h3>
<p>Go对能见到的常用的数据库几乎都支持，并且有Gorm支持。</p>
<p>Gorm允许定义关系、实施数据迁移、串联多个查询以及执行其他的很多高级操作，还可以设置回调函数等。</p>
<blockquote>
<p>GORM中文文档：</p>
<p><a class="link" href="https://gorm.io/zh_CN/docs/"  target="_blank" rel="noopener"
    >GORM 指南 | GORM - The fantastic ORM library for Golang, aims to be developer friendly.</a></p>
</blockquote>
<h2 id="7-发挥go的并发优势">7. 发挥Go的并发优势</h2>
<p>这部分内容会更新到我之前写的Go并发的博文中。</p>
<p><a class="link" href="https://lizonglin313.github.io/post/goroutine-ren-wu-kong-zhi/"  target="_blank" rel="noopener"
    >Go的并发与任务控制 - Big Carrot (lizonglin313.github.io)</a></p>

</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/golang/">Golang</a>
        
            <a href="/tags/web/">Web</a>
        
    </section>


    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    </footer>


    
        <link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/katex.min.css"integrity="sha256-J&#43;iAE0sgH8QSz9hpcDxXIftnj65JEZgNhGcgReTTK9s="crossorigin="anonymous"
            ><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/katex.min.js"integrity="sha256-InsNdER1b2xUewP&#43;pKCUJpkhiqwHgqiPXDlIk7GzBu4="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/contrib/auto-render.min.js"integrity="sha256-y39Mpg7V3D4lhBX4x6O0bUqTV4pSrfgwEfGKfxkOdgI="crossorigin="anonymous"
                defer
                >
            </script><script>
    window.addEventListener("DOMContentLoaded", () => {
        renderMathInElement(document.querySelector(`.article-content`), {
            delimiters: [
                { left: "$$", right: "$$", display: true },
                { left: "$", right: "$", display: false },
                { left: "\\(", right: "\\)", display: false },
                { left: "\\[", right: "\\]", display: true }
            ]
        });})
</script>
    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">相关文章</h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="">
    <a href="/p/go%E7%9A%84%E5%8C%BF%E5%90%8D%E5%87%BD%E6%95%B0%E9%97%AD%E5%8C%85/">
        
        

        <div class="article-details">
            <h2 class="article-title">Go的匿名函数(闭包)</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/go-web%E5%9F%BA%E7%A1%80/">
        
        

        <div class="article-details">
            <h2 class="article-title">Go Web基础</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/%E5%85%B3%E4%BA%8Ehandlehandlefunchandler%E5%92%8Chandlerfunc/">
        
        

        <div class="article-details">
            <h2 class="article-title">关于Handle、HandleFunc、Handler和HandlerFunc</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/golang-jsonrpc-demo/">
        
        

        <div class="article-details">
            <h2 class="article-title">Golang Jsonrpc Demo</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/golang%E6%8E%A5%E5%8F%A3/">
        
        

        <div class="article-details">
            <h2 class="article-title">Golang接口</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2018 - 
        
        2023 Li Duo
    </section>
    
    <section class="powerby">
        
            自认为是幻象波普星的来客 <br/>
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        主题 <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.16.0">Stack</a></b> 由 <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> 设计
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
